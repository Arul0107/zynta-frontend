import{q as t,O as Ae,s as v,V as g}from"./index-Db3Ct3vh.js";import{aj as We,r as d,F as S,d as c,S as V,B as f,P as de,m as K,T as Le,l as P,o as he,n as Y,C as M,b as He,M as me,c as $e}from"./antd-CjRtIVzR.js";import{f as ue}from"./icons-De3RWgvB.js";import"./react-DoC2WAmd.js";const{Title:k}=Le,{TextArea:Ve}=$e,{Option:w}=P,{RangePicker:Ye}=he,{useBreakpoint:Pe}=We;function Je(){var re,le;const pe=Pe(),[b,C]=d.useState([]),[N,T]=d.useState(!1),[ge,R]=d.useState(!1),[Q,X]=d.useState(null),[D]=S.useForm(),[A,W]=d.useState({}),[y,B]=d.useState({}),[L,fe]=d.useState([]),[H,xe]=d.useState([]),[ye,z]=d.useState(!1),[u,je]=d.useState(null),[Z,Be]=d.useState(!1),[ee,U]=d.useState("today"),[te,Se]=d.useState({}),[$,ke]=d.useState({totalSessions:0,sessionsStopped:0,totalWorkedHours:0,uniqueWorkingDays:0}),[p,q]=d.useState([c().startOf("day"),c().endOf("day")]),x=JSON.parse(localStorage.getItem("user"))||{_id:"temp_id_123",name:"Guest User",role:"Employee",email:"guest@example.com"},O=["Superadmin"].includes(x.role),se=e=>{const s=Math.floor(Math.abs(e)/3600),n=Math.floor(Math.abs(e)%3600/60),a=Math.floor(Math.abs(e)%60);return`${e<0?"+":""}${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},_=e=>{if(e==null)return"";const s=Math.floor(e*3600),n=Math.floor(s/3600),a=Math.floor(s%3600/60),i=s%60;return`${n}h ${a}m ${i}s`},ne=e=>{const s=c();switch(e){case"today":return[s.startOf("day"),s.endOf("day")];case"thisWeek":return[s.startOf("week"),s.endOf("week")];case"thisMonth":return[s.startOf("month"),s.endOf("month")];case"custom":default:return p}},Te=e=>{if(e&&e.length===2&&c.isDayjs(e[0])&&c.isDayjs(e[1]))q(e),U("custom");else{const s=ne("today");q(s),U("today")}},Ie=e=>{if(U(e),e!=="custom"){const s=ne(e);q(s)}},ve=e=>{const s=e.reduce((o,m)=>o+(m.totalHours||0),0),n=e.length,a=e.filter(o=>o.logoutTime).length,r=new Set(e.map(o=>o.dateLabel)).size;ke({totalSessions:n,sessionsStopped:a,totalWorkedHours:s,uniqueWorkingDays:r})},we=async()=>{try{const[e,s]=await Promise.all([v.get("/api/accounts"),v.get("/api/service")]);fe(e.data||[]),xe(s.data||[])}catch{g.error("Failed to fetch accounts or services")}},oe=async()=>{try{T(!0);let e,s;p&&p.length===2&&c.isDayjs(p[0])&&c.isDayjs(p[1])?(e=p[0].startOf("day").toISOString(),s=p[1].endOf("day").toISOString()):(e=c().startOf("day").toISOString(),s=c().endOf("day").toISOString());const n={start:e,end:s};O||(n.userId=x._id);const i=(await v.get("/api/work-sessions/range",{params:n})).data.history||[],r=[];i.forEach(l=>{l.sessions.forEach(h=>{var E,F,j,ce;if(O||h.userId===x._id){const Ne=((F=(E=h.accountIds)==null?void 0:E.map(G=>L.find(J=>J._id===G)))==null?void 0:F.filter(Boolean))||[],Re=((ce=(j=h.serviceIds)==null?void 0:j.map(G=>H.find(J=>J._id===G)))==null?void 0:ce.filter(Boolean))||[];r.push({...h,key:h._id,dateLabel:l.date,loginTimeFormatted:c(h.loginTime).format("hh:mm:ss A"),logoutTimeFormatted:h.logoutTime?c(h.logoutTime).format("hh:mm:ss A"):"",accountIds:Ne,serviceIds:Re})}})}),C(r);const o={},m={};r.forEach(l=>{const h=l.totalHours?Math.floor(l.totalHours*3600):0;o[l.key]=l.logoutTime?h:Math.floor(8*3600-(Date.now()-new Date(l.loginTime).getTime())/1e3),m[l.key]=!l.logoutTime}),W(o),B(m)}catch(e){console.error(e),g.error("Failed to fetch sessions")}finally{T(!1)}};d.useEffect(()=>{we()},[]),d.useEffect(()=>{p&&p.length===2&&oe()},[p,L.length,H.length]),d.useEffect(()=>{const e=setInterval(()=>{W(s=>{const n={};return Object.keys(s).forEach(a=>{n[a]=y[a]?s[a]-1:s[a]}),n})},1e3);return()=>clearInterval(e)},[y]);const I=d.useMemo(()=>{let e=b;Z&&(e=e.filter(n=>c(n.loginTime).day()!==0));const s=te.name;return s&&s.length>0&&(e=e.filter(n=>s.includes(n.name))),e},[b,Z,te]);d.useEffect(()=>{ve(I)},[I]);const be=(e,s,n)=>{Se(s)},De=async()=>{var s,n;if(Object.values(y).some(a=>a)){g.error("A work session is already running.");return}T(!0);try{const i=(await v.post("/api/work-sessions/start",{userId:x._id,name:x.name,email:x.email})).data.session,r={key:i._id,...i,loginTimeFormatted:c(i.loginTime).format("hh:mm:ss A"),logoutTimeFormatted:"",dateLabel:c(i.loginTime).format("DD-MM-YYYY"),accountIds:[],serviceIds:[]};C(o=>[r,...o]),W(o=>({...o,[i._id]:Math.floor(8*3600-(Date.now()-new Date(i.loginTime).getTime())/1e3)})),B(o=>({...o,[i._id]:!0})),g.success("Work started successfully!")}catch(a){g.error(((n=(s=a.response)==null?void 0:s.data)==null?void 0:n.message)||"Failed to start work")}finally{T(!1)}},ae=async e=>{var s,n;T(!0);try{const i=(await v.post("/api/work-sessions/stop",{sessionId:e})).data.session;C(r=>r.map(o=>o.key===e?{...o,logoutTimeFormatted:c(i.logoutTime).format("hh:mm:ss A"),totalHours:i.totalHours}:o)),B(r=>({...r,[e]:!1})),W(r=>({...r,[e]:Math.floor(i.totalHours*3600)})),g.success("Work stopped successfully!")}catch(a){g.error(((n=(s=a.response)==null?void 0:s.data)==null?void 0:n.message)||"Failed to stop work")}finally{T(!1)}},Oe=async e=>{var s,n,a,i;try{await v.post("/api/work-sessions/eod",{sessionId:Q.key,eod:e.eod,accountIds:e.accountIds,serviceIds:e.serviceIds,date:e.date?e.date.toISOString():null});const r=((n=(s=e.accountIds)==null?void 0:s.map(m=>L.find(l=>l._id===m)))==null?void 0:n.filter(Boolean))||[],o=((i=(a=e.serviceIds)==null?void 0:a.map(m=>H.find(l=>l._id===m)))==null?void 0:i.filter(Boolean))||[];C(m=>m.map(l=>l.key===Q.key?{...l,eod:e.eod,accountIds:r,serviceIds:o,date:e.date?e.date.toISOString():l.date}:l)),R(!1),D.resetFields(),g.success("EOD saved!")}catch{g.error("Failed to save EOD")}},ie=e=>{je(e),z(!0)},_e=()=>{if(I.length===0){g.error("No data to export.");return}const e=["S.No.","Date","Name","Login Time","Logout Time","Worked Hours","EOD Message","Accounts","Services"],s=I.map((o,m)=>{var E,F;const l=((E=o.accountIds)==null?void 0:E.map(j=>j.businessName).join(" | "))||"",h=((F=o.serviceIds)==null?void 0:F.map(j=>j.serviceName||j.name).join(" | "))||"";return[m+1,`"${o.dateLabel}"`,`"${o.name}"`,`"${o.loginTimeFormatted}"`,`"${o.logoutTimeFormatted}"`,`"${_(o.totalHours)}"`,`"${(o.eod||"").replace(/"/g,'""').replace(/\n/g," ")}"`,`"${l}"`,`"${h}"`].join(",")}),n=[e.join(","),...s].join(`
`),a=new Blob([n],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(a),r=document.createElement("a");r.setAttribute("href",i),r.setAttribute("download",`timesheet_report_${c().format("YYYYMMDD_HHmmss")}.csv`),r.click(),g.success("Report downloaded successfully!")},Ee=[{title:"S.No.",key:"sno",render:(e,s,n)=>n+1,width:60,fixed:"left",align:"center"},{title:"Date",dataIndex:"dateLabel",responsive:["md"]},{title:"Name",dataIndex:"name",responsive:["lg"],filters:Array.from(new Set(b.map(e=>e.name))).map(e=>({text:e,value:e})),onFilter:(e,s)=>s.name===e,key:"name"},{title:"Login",dataIndex:"loginTimeFormatted"},{title:"Logout",dataIndex:"logoutTimeFormatted"},{title:"Timer",render:(e,s)=>t.jsx("span",{className:y[s.key]?"countdown":A[s.key]<0?"overtime":"",children:se(A[s.key]||0)})},{title:"Worked Hours",dataIndex:"totalHours",render:(e,s)=>_(s.totalHours),responsive:["md"]},{title:"EOD",render:(e,s)=>t.jsxs(V,{size:"small",children:[t.jsx(f,{type:"link",size:"small",onClick:()=>{var n,a;X(s),R(!0),D.setFieldsValue({eod:s.eod||"",accountIds:((n=s.accountIds)==null?void 0:n.map(i=>i._id))||[],serviceIds:((a=s.serviceIds)==null?void 0:a.map(i=>i._id))||[],date:s.date?c(s.date):c(s.loginTime)})},children:s.eod?"Edit":"Add"}),s.eod&&t.jsx(f,{type:"link",size:"small",onClick:()=>ie(s),children:"View"})]})},{title:"Actions",render:(e,s)=>{const n=y[s.key],a=s.userId===x._id;return n&&(O||a)?t.jsx(de,{title:"Are you sure you want to stop work?",onConfirm:()=>ae(s.key),okText:"Yes",cancelText:"No",children:t.jsx(f,{type:"text",danger:!0,size:"small",icon:t.jsx(ue,{}),children:"Stop"})}):null}}],Fe=b.some(e=>e.userId===x._id&&y[e.key]),Me=!pe.md,Ce=()=>t.jsx(V,{direction:"vertical",style:{width:"100%"},children:I.map(e=>{const s=y[e.key],n=e.userId===x._id,a=s&&(O||n),i={borderLeft:`2px solid ${s?"#52c41a":e.logoutTime?"#1677ff":"#faad14"}`};return t.jsxs(M,{className:"timesheet-mobile-card",title:t.jsxs(K,{justify:"space-between",align:"middle",children:[t.jsx(k,{level:5,style:{margin:0},children:e.dateLabel}),t.jsx(k,{level:5,style:{margin:0},children:e.name}),t.jsx("span",{className:s?"countdown":A[e.key]<0?"overtime":"",children:se(A[e.key]||0)})]}),extra:a?t.jsx(de,{title:"Stop work?",onConfirm:()=>ae(e.key),okText:"Yes",cancelText:"No",children:t.jsx(f,{type:"text",danger:!0,size:"small",icon:t.jsx(ue,{}),style:{padding:"4px 8px"},children:"Stop"})}):null,style:i,loading:N,children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Login:"})," ",e.loginTimeFormatted]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Logout:"})," ",e.logoutTimeFormatted||"RUNNING"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Worked:"})," ",_(e.totalHours)]}),t.jsxs(V,{size:"middle",style:{marginTop:8},children:[t.jsxs(f,{type:"link",size:"small",onClick:()=>{var r,o;X(e),R(!0),D.setFieldsValue({eod:e.eod||"",accountIds:((r=e.accountIds)==null?void 0:r.map(m=>m._id))||[],serviceIds:((o=e.serviceIds)==null?void 0:o.map(m=>m._id))||[],date:e.date?c(e.date):c(e.loginTime)})},children:["EOD (",e.eod?"Edit":"Add",")"]}),e.eod&&t.jsx(f,{type:"link",size:"small",onClick:()=>ie(e),children:"View Details"})]})]},e.key)})});return t.jsxs("div",{className:"timesheet-dashboard-container",children:[t.jsx(Ae,{position:"top-right",reverseOrder:!1}),t.jsxs(K,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[t.jsx(k,{level:2,children:"Timesheet Dashboard"}),t.jsxs(V,{wrap:!0,size:"middle",children:[t.jsxs(P,{value:ee,onChange:Ie,style:{width:120},children:[t.jsx(w,{value:"today",children:"Today"}),t.jsx(w,{value:"thisWeek",children:"This Week"}),t.jsx(w,{value:"thisMonth",children:"This Month"}),t.jsx(w,{value:"custom",children:"Custom Range"})]}),t.jsx(Ye,{onChange:Te,value:p,style:{width:"100%"},disabled:ee!=="custom"}),t.jsx(f,{type:"primary",className:"add-event-button",onClick:oe,loading:N,children:"Fetch History"}),t.jsx(f,{onClick:_e,disabled:I.length===0,children:"Export Report"}),!O&&!Fe&&t.jsx(f,{type:"primary",loading:N,onClick:De,children:"Start Work"})]})]}),t.jsxs(K,{gutter:[16,16],style:{marginBottom:24},children:[t.jsx(Y,{xs:12,sm:6,children:t.jsx(M,{title:"Total Sessions",bordered:!1,className:"stat-card",children:t.jsx(k,{level:3,style:{margin:0},children:$.totalSessions})})}),t.jsx(Y,{xs:12,sm:6,children:t.jsx(M,{title:"Working Days",bordered:!1,className:"stat-card",children:t.jsx(k,{level:3,style:{margin:0},children:$.uniqueWorkingDays})})}),t.jsx(Y,{xs:12,sm:6,children:t.jsx(M,{title:"Sessions Stopped",bordered:!1,className:"stat-card",children:t.jsx(k,{level:3,style:{margin:0},children:$.sessionsStopped})})}),t.jsx(Y,{xs:12,sm:6,children:t.jsx(M,{title:"Total Worked Time",bordered:!1,className:"stat-card",children:t.jsx(k,{level:3,style:{margin:0},children:_($.totalWorkedHours)})})})]}),Me?Ce():t.jsx(He,{columns:Ee,dataSource:b,pagination:!1,rowKey:"key",loading:N,scroll:{x:"max-content"},onChange:be}),t.jsx(me,{title:"End of Day Notes",open:ge,onCancel:()=>{R(!1),D.resetFields()},footer:null,children:t.jsxs(S,{form:D,layout:"vertical",onFinish:Oe,children:[t.jsx(S.Item,{label:"EOD Message",name:"eod",rules:[{required:!0,message:"Please enter your EOD message"}],children:t.jsx(Ve,{rows:4})}),t.jsx(S.Item,{label:"Select Accounts",name:"accountIds",rules:[{type:"array",message:"Please select at least one account"}],children:t.jsx(P,{mode:"multiple",placeholder:"Select accounts",children:L.map(e=>t.jsx(w,{value:e._id,children:e.businessName},e._id))})}),t.jsx(S.Item,{label:"Select Services",name:"serviceIds",rules:[{type:"array",message:"Please select at least one service"}],children:t.jsx(P,{mode:"multiple",placeholder:"Select services",children:H.map(e=>t.jsx(w,{value:e._id,children:e.serviceName||e.name},e._id))})}),t.jsx(S.Item,{label:"Date",name:"date",children:t.jsx(he,{style:{width:"100%"}})}),t.jsx(S.Item,{children:t.jsx(f,{type:"primary",htmlType:"submit",children:"Save EOD"})})]})}),t.jsx(me,{title:`EOD Details - ${u==null?void 0:u.name}`,open:ye,onCancel:()=>z(!1),footer:t.jsx(f,{onClick:()=>z(!1),children:"Close"}),width:700,children:u&&t.jsxs("div",{children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Date:"})," ",u.date?c(u.date).format("DD-MM-YYYY"):u.dateLabel||"-"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Login:"})," ",u.loginTimeFormatted||"-"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Logout:"})," ",u.logoutTimeFormatted||"-"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Worked Hours:"})," ",_(u.totalHours)]}),t.jsx("p",{children:t.jsx("strong",{children:"EOD Message:"})}),t.jsx("pre",{style:{whiteSpace:"pre-wrap",background:"#f5f5f5",padding:10,borderRadius:4},children:u.eod||"No EOD provided"}),t.jsx("p",{children:t.jsx("strong",{children:"Accounts:"})}),t.jsx("ul",{children:((re=u.accountIds)==null?void 0:re.map(e=>t.jsx("li",{children:e.businessName},e._id)))||t.jsx("li",{children:"-"})}),t.jsx("p",{children:t.jsx("strong",{children:"Services:"})}),t.jsx("ul",{children:((le=u.serviceIds)==null?void 0:le.map(e=>t.jsx("li",{children:e.serviceName||e.name},e._id)))||t.jsx("li",{children:"-"})})]})})]})}export{Je as default};
