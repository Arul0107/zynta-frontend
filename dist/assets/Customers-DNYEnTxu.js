import{r as n,U as je,x as t,y as be,B as v,S as we,H as i,as as Te,at as b}from"./index-DysXtrl7.js";import{i as C}from"./axios-Dbq_CbWC.js";import{R as ze,a as Ie,B as Ne,F as Ae,N as Ee,b as $e}from"./FollowUpDrawer-UDFt6CS3.js";import{h as Fe,E as ve,R as De}from"./html2canvas.esm-B6o5izMP.js";import{u as D,a as _e}from"./xlsx-CyWl6TWy.js";import{C as Le}from"./index-IahplJ7o.js";import{R as ke,C as _}from"./row-BYIzmBXD.js";import{T as Re}from"./index-PWcPX8J0.js";import{I as Be}from"./index-N4YTd5WF.js";import{R as Ue}from"./TextArea-Bqbh4RKI.js";import{T as G}from"./index-CL3JxQbZ.js";import{F as Pe}from"./Table-DflE-h7Z.js";import{E as Ve}from"./index-qBajPA1p.js";import{M as Ze}from"./index-B0qVLxDy.js";import{T}from"./index-BBTWRX9T.js";import{R as Oe}from"./EditOutlined-C9Bhlaw5.js";import{R as Me}from"./MessageOutlined-BZo189Jp.js";import{P as He}from"./index-th8N7Gjr.js";import{R as Ge}from"./DeleteOutlined-ine2ZxG6.js";import"./index-cDs3jJ7o.js";import"./index-BYWlwTeH.js";import"./context-DDkc41cA.js";import"./useClosable-DxUighul.js";import"./extendsObject-78o_rR5W.js";import"./MinusCircleOutlined-B9O64eBj.js";import"./PlusOutlined-BIwFneT8.js";import"./index-0wDzc6vO.js";import"./index-CWHtsAdS.js";import"./moment-C5S46NFB.js";import"./index-BVasZ5yH.js";import"./dayjs.min-DoBvc7g8.js";import"./index-DVuuwvNm.js";import"./Pagination-ByOtUXMd.js";import"./styleChecker-w1bbWMN2.js";import"./addEventListener-D04I5D8z.js";import"./index-BrgBQ01W.js";import"./InfoCircleFilled-6_sUPPXN.js";import"./ActionButton-C6N_UzTp.js";import"./index-1L-XTNt_.js";const{Title:We}=Re,{TabPane:H}=G,z="/api/accounts",_t=()=>{const[m,W]=n.useState(""),[u,Y]=n.useState("all"),[I,K]=n.useState([]),[L,h]=n.useState(!1),[J,q]=n.useState([]),[Q,k]=n.useState(!1),[R,X]=n.useState([]),[ee,B]=n.useState(!1),[te,A]=n.useState(!1),[f,U]=n.useState(null),[se,E]=n.useState(!1),[w,P]=n.useState(null),[$,V]=n.useState(null),[oe,Z]=n.useState(!1),[re,O]=n.useState(!1),[F,M]=n.useState(null),ae=je();n.useRef(null);const j=JSON.parse(localStorage.getItem("user")),x=j==null?void 0:j.role,p=j==null?void 0:j._id,[a,N]=n.useState({current:1,pageSize:10,total:0}),y=async(e={})=>{h(!0);try{const{current:s=a.current,pageSize:r=a.pageSize,searchText:o="",sortBy:c="createdAt",sortOrder:g="desc",zoneId:d=u}=e;let l=`${z}/paginated?page=${s}&pageSize=${r}&search=${o}&status=Customer`;c&&(l+=`&sortBy=${c}`),g&&(l+=`&sortOrder=${g}`),x==="Employee"&&p?l+=`&userId=${p}&role=${x}`:x==="Team Leader"&&p&&(l+=`&teamLeaderId=${p}&role=${x}`),d&&d!=="all"&&(l+=`&zone=${d}`);const S=await C.get(l);K(S.data.data),N({...a,current:S.data.page,pageSize:S.data.pageSize,total:S.data.total})}catch(s){i.error("Failed to load customers"),console.error("Error fetching customers:",s)}finally{h(!1)}},ne=async()=>{k(!0);try{const e=await C.get("/api/accounts/users");q(e.data)}catch(e){i.error("Failed to load user list"),console.error("Error fetching users:",e)}finally{k(!1)}},ie=async()=>{B(!0);try{let e="/api/zones";x==="Employee"&&p?e+=`?userId=${p}`:x==="Team Leader"&&p&&(e+=`?teamLeaderId=${p}`);const s=await C.get(e);X(s.data)}catch(e){console.error("Error fetching zones:",e),i.error("Failed to load zones.")}finally{B(!1)}},le=e=>{Y(e),N({...a,current:1})};n.useEffect(()=>{y({current:a.current,pageSize:a.pageSize,searchText:m,zoneId:u}),ne(),ie()},[a.current,a.pageSize,m,x,p,u]);const ce=e=>{U(e),A(!0)},de=async e=>{var s;h(!0);try{f!=null&&f._id?(await C.put(`${z}/${f._id}`,e),i.success("Customer updated successfully")):(await C.post(z,e),i.success("Customer created successfully")),y({current:a.current,pageSize:a.pageSize,searchText:m,zoneId:u})}catch(r){i.error(`Failed to ${f!=null&&f._id?"update":"create"} customer`),console.error("Save customer error:",((s=r.response)==null?void 0:s.data)||r.message)}finally{A(!1),U(null),h(!1)}},ue=(e,s)=>{P(s),V(e),E(!0)},me=async()=>{var e;h(!0);try{const s={...w,status:$};await C.put(`${z}/${w._id}`,s),i.success(`Status updated to ${$}`),y({current:a.current,pageSize:a.pageSize,searchText:m,zoneId:u})}catch(s){i.error("Failed to update status"),console.error("Status update error:",((e=s.response)==null?void 0:e.data)||s.message)}finally{E(!1),P(null),V(null),h(!1)}},pe=async e=>{var s;h(!0);try{await C.put(`${z}/${e}`,{status:"Closed",isCustomer:!1}),i.success("Customer status set to Closed"),y({current:a.current,pageSize:a.pageSize,searchText:m,zoneId:u})}catch(r){i.error("Failed to close customer account"),console.error("Soft delete error:",((s=r.response)==null?void 0:s.data)||r.message)}finally{h(!1)}},ge=e=>{M(e),Z(!0)},he=e=>{M(e),O(!0)},fe=e=>{ae(`/customers/${e._id}`)},xe=async()=>{const e=document.getElementById("customerTable");if(!e){i.error("Table content not found for PDF export.");return}i.loading("Generating PDF...",{id:"pdf-toast"});try{const s=await Fe(e,{scale:2}),r=s.toDataURL("image/png"),o=new ve("p","mm","a4"),c=210,g=297,d=s.height*c/s.width;let l=d,S=0;for(o.addImage(r,"PNG",0,S,c,d),l-=g;l>=0;)S=l-d,o.addPage(),o.addImage(r,"PNG",0,S,c,d),l-=g;o.save("Customers_Details.pdf"),i.success("PDF generated!",{id:"pdf-toast"})}catch(s){console.error("Error generating PDF:",s),i.error("Failed to generate PDF.",{id:"pdf-toast"})}},Se=()=>{if(I.length===0){i.error("No data to export to Excel.");return}const e=I.map((o,c)=>{var d,l;return{"S.No":c+1+(a.current-1)*a.pageSize,"Business Name":o.businessName,"Contact Name":o.contactName,Email:o.email,"Mobile Number":o.mobileNumber,"Lead Type":o.type,Status:o.status,"Source Type":o.sourceType,"Assigned To":((d=o.assignedTo)==null?void 0:d.name)||"Unassigned","GST Number":o.gstNumber,"Phone Number":o.phoneNumber,"Address Line 1":o.addressLine1,"Address Line 2":o.addressLine2,"Address Line 3":o.addressLine3,Landmark:o.landmark,City:o.city,Pincode:o.pincode,State:o.state,Country:o.country,Website:o.website,"Is Customer":o.isCustomer?"Yes":"No","Created At":new Date(o.createdAt).toLocaleString(),Zone:((l=o.zone)==null?void 0:l.name)||"N/A"}}),s=D.json_to_sheet(e),r=D.book_new();D.book_append_sheet(r,s,"Customers Data"),_e(r,"Customers_Data.xlsx"),i.success("Data exported to Excel!")},ye=[{title:"Sno.",render:(e,s,r)=>r+1+(a.current-1)*a.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",render:(e,s)=>t.jsx("a",{onClick:()=>fe(s),style:{cursor:"pointer",color:"#0E2B43"},children:e}),sorter:!0},{title:"Contact Name",dataIndex:"contactName",sorter:!0},{title:"Email Id",dataIndex:"email",sorter:!0},{title:"Type",dataIndex:"type",render:e=>{switch(e){case"Hot":return t.jsx(T,{color:"red",children:"Hot"});case"Warm":return t.jsx(T,{color:"orange",children:"Warm"});case"Cold":return t.jsx(T,{color:"blue",children:"Cold"});default:return t.jsx(T,{children:"Unknown"})}},sorter:!0},{title:"Assigned To",dataIndex:["assignedTo","name"],render:(e,s)=>s.assignedTo?t.jsxs("span",{children:[s.assignedTo.name," (",s.assignedTo.role,")"]}):t.jsx("em",{children:"Unassigned"}),sorter:!0},{title:"Zone",dataIndex:["zone","name"],render:e=>e||"N/A",sorter:(e,s)=>{var c,g;const r=((c=e.zone)==null?void 0:c.name)||"",o=((g=s.zone)==null?void 0:g.name)||"";return r.localeCompare(o)}},{title:"Latest Note",render:(e,s)=>{var o;const r=(o=s.notes)==null?void 0:o[s.notes.length-1];return r?t.jsxs("div",{children:[t.jsx("small",{style:{color:"#888"},children:new Date(r.timestamp).toLocaleString()}),t.jsx("br",{}),r.text]}):t.jsx("em",{children:"No notes"})}},{title:"Status",dataIndex:"status",render:(e,s)=>t.jsx(T,{color:s.status==="Customer"?"blue":"gray",children:s.status}),sorter:!0},{title:"Actions",render:(e,s)=>t.jsx(Te,{overlay:t.jsxs(b,{children:[t.jsx(b.Item,{icon:t.jsx(Oe,{}),onClick:()=>ce(s),children:"Edit Customer"},"edit"),t.jsx(b.Item,{icon:t.jsx(Me,{}),onClick:()=>ge(s),children:"View/Add Notes"},"notes"),t.jsx(b.Item,{icon:t.jsx($e,{}),onClick:()=>he(s),children:"View/Add Follow-ups"},"followups"),t.jsx(b.Item,{onClick:()=>ue("Active",s),children:"Change to Active Lead"},"change-to-active"),x==="Superadmin"&&t.jsx(b.Item,{children:t.jsxs(He,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>pe(s._id),okText:"Yes",cancelText:"No",children:[t.jsx(Ge,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:t.jsx(v,{icon:t.jsx(De,{})})})}],Ce=(e,s,r)=>{N(e);const o=r.field,c=r.order==="ascend"?"asc":r.order==="descend"?"desc":void 0;y({current:e.current,pageSize:e.pageSize,searchText:m,sortBy:o,sortOrder:c,zoneId:u})};return t.jsxs("div",{children:[t.jsxs(Le,{children:[t.jsxs(ke,{gutter:[16,16],align:"middle",style:{marginBottom:16},children:[t.jsx(_,{xs:24,sm:12,md:8,lg:6,children:t.jsx(We,{level:4,style:{margin:0},children:"Customers"})}),t.jsx(_,{xs:24,sm:12,md:8,lg:6,children:t.jsx(Be,{placeholder:"Search by Business Name, Contact Name or Email",prefix:t.jsx(Ue,{}),value:m,onChange:e=>{W(e.target.value),N({...a,current:1})},style:{width:"100%"}})}),t.jsx(_,{xs:24,sm:24,md:8,lg:12,style:{display:"flex",justifyContent:"flex-end"},children:t.jsxs(be,{wrap:!0,children:[t.jsx(v,{icon:t.jsx(ze,{}),onClick:xe,style:{backgroundColor:"#0E2B43",borderColor:"#0E2B43",color:"white"},className:"orange-button",children:"Export to PDF"}),t.jsx(v,{icon:t.jsx(Ie,{}),onClick:Se,style:{backgroundColor:"#0E2B43",borderColor:"#0E2B43",color:"white"},className:"orange-button",children:"Export to Excel"})]})})]}),t.jsxs(G,{activeKey:u,onChange:le,style:{marginBottom:16},children:[t.jsx(H,{tab:"All Customers"},"all"),R.map(e=>t.jsx(H,{tab:t.jsx("span",{children:e.name})},e._id))]}),L?t.jsx(we,{size:"large",style:{display:"block",margin:"50px auto"}}):I.length>0?t.jsx("div",{id:"customerTable",children:t.jsx(Pe,{columns:ye,dataSource:I,rowKey:"_id",pagination:a,onChange:Ce,scroll:{x:"max-content"},className:"customers-table"})}):t.jsx(Ve,{description:"No customers found."})]}),t.jsx(Ne,{visible:te,onClose:()=>A(!1),onSave:de,initialValues:f,allUsers:J,loadingUsers:Q,allZones:R,loadingZones:ee}),t.jsx(Ze,{title:"Confirm Status Change",open:se,onOk:me,onCancel:()=>E(!1),okText:"Yes",cancelText:"No",confirmLoading:L,children:t.jsxs("p",{children:["Are you sure you want to change the status of ",t.jsx("strong",{children:w==null?void 0:w.businessName})," to ",t.jsx("strong",{children:$}),"?"]})}),F&&t.jsxs(t.Fragment,{children:[t.jsx(Ae,{visible:re,onClose:()=>O(!1),account:F,refreshAccounts:()=>y({current:a.current,pageSize:a.pageSize,searchText:m,zoneId:u})}),t.jsx(Ee,{visible:oe,onClose:()=>Z(!1),account:F,refreshAccounts:()=>y({current:a.current,pageSize:a.pageSize,searchText:m,zoneId:u})})]})]})};export{_t as default};
