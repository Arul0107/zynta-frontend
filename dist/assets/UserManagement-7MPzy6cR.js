import{s as f,q as e,V as m}from"./index-Db3Ct3vh.js";import{r as j,F as n,S as B,B as o,v as $,b as O,D as U,l as u,c as C,y as Z,aw as ee,P as ae,a as se}from"./antd-CjRtIVzR.js";import{$ as te}from"./icons-De3RWgvB.js";import"./react-DoC2WAmd.js";const{Option:r}=u,{TabPane:V}=$,de=({users:F,departments:_,teams:T,fetchUsers:v,fetchDepartments:I,fetchTeams:g,loading:D})=>{const[q,x]=j.useState(!1),[i,S]=j.useState(null),[d]=n.useForm(),[E,P]=j.useState([]),[L,w]=j.useState(!1),[y,M]=j.useState(null),[A]=n.useForm(),l=JSON.parse(localStorage.getItem("user")),c=(l==null?void 0:l.role)==="Superadmin",p=(l==null?void 0:l.role)==="Admin",K=(l==null?void 0:l.role)==="Team Leader";j.useEffect(()=>{z()},[]);const z=async()=>{try{const a=await f.get("/api/accounts");P(a.data||[])}catch(a){console.error("Failed to load business accounts",a)}},J=()=>{S(null),d.resetFields(),d.setFieldsValue({role:"Employee",status:"Active"}),x(!0)},Y=()=>{S(null),d.resetFields(),d.setFieldsValue({role:"Client",status:"Active"}),x(!0)},G=a=>{var s,t,b;S(a),d.setFieldsValue({name:a.name,email:a.email,mobile:a.mobile,role:a.role,status:a.status,businessAccount:(s=a.businessAccount)==null?void 0:s._id,department:(t=a.department)==null?void 0:t._id,team:(b=a.team)==null?void 0:b._id}),x(!0)},H=async()=>{var a,s;try{const t=await d.validateFields();i&&!t.password&&delete t.password,i?(await f.put(`/api/users/${i._id}`,t),m.success("User updated successfully")):(await f.post("/api/users",t),m.success("User created successfully")),x(!1),v(),I(),g()}catch(t){m.error(((s=(a=t==null?void 0:t.response)==null?void 0:a.data)==null?void 0:s.message)||"Failed to save")}},Q=async a=>{try{if(a===l._id){m.error("You cannot delete your own account!");return}await f.delete(`/api/users/${a}`),m.success("User deleted"),v(),I(),g()}catch{m.error("Failed to delete")}},W=a=>{var s,t;M(a),A.setFieldsValue({newDepartment:(s=a.department)==null?void 0:s._id,newTeam:(t=a.team)==null?void 0:t._id}),w(!0)},X=async()=>{try{const a=await A.validateFields();await f.put(`/api/users/transfer/${y._id}`,{departmentId:a.newDepartment,teamId:a.newTeam}),m.success("User transferred successfully!"),w(!1),v(),I(),g()}catch{m.error("Transfer failed")}},N=F.filter(a=>a.role!=="Client"),k=F.filter(a=>a.role==="Client"),R=[{title:"Name",dataIndex:"name"},{title:"Email",dataIndex:"email"},{title:"Mobile",dataIndex:"mobile"},{title:"Role",dataIndex:"role"},{title:"Status",dataIndex:"status"},{title:"Department",dataIndex:"department",render:a=>(a==null?void 0:a.name)||"N/A"},{title:"Team",dataIndex:"team",render:a=>(a==null?void 0:a.name)||"N/A"},{title:"Actions",render:(a,s)=>{var b;const t=K&&l.team&&((b=s.team)==null?void 0:b._id)&&l.team===s.team._id;return e.jsxs(B,{children:[(c||p||t)&&e.jsx(o,{icon:e.jsx(Z,{}),onClick:()=>G(s)}),(c||p)&&e.jsx(o,{icon:e.jsx(ee,{}),onClick:()=>W(s)}),(c||p)&&e.jsx(ae,{title:"Delete user?",onConfirm:()=>Q(s._id),children:e.jsx(o,{danger:!0,icon:e.jsx(se,{})})})]})}}],h=d.getFieldValue("role");return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16},children:[e.jsx("h2",{children:"User Management"}),(c||p)&&e.jsxs(B,{children:[e.jsx(o,{type:"primary",icon:e.jsx(te,{}),onClick:J,children:"Create User (Internal)"}),e.jsx(o,{type:"primary",style:{backgroundColor:"#3BAFDA"},onClick:Y,children:"Create Client"})]})]}),e.jsxs($,{defaultActiveKey:"internal",children:[e.jsx(V,{tab:e.jsxs("span",{children:["Internal Staff (",N.length,")"]}),children:e.jsx(O,{columns:R,dataSource:N,loading:D,bordered:!0,rowKey:"_id",pagination:{pageSize:10}})},"internal"),e.jsx(V,{tab:e.jsxs("span",{children:["Clients (",k.length,")"]}),children:e.jsx(O,{columns:R,dataSource:k,loading:D,bordered:!0,rowKey:"_id",pagination:{pageSize:10}})},"client")]}),e.jsx(U,{title:i?"Edit User":"Create User",open:q,onClose:()=>x(!1),width:420,destroyOnClose:!0,footer:e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx(o,{onClick:()=>x(!1),style:{marginRight:8},children:"Cancel"}),e.jsx(o,{type:"primary",onClick:H,children:i?"Update":"Create"})]}),children:e.jsxs(n,{form:d,layout:"vertical",children:[e.jsx(n.Item,{name:"role",label:"Role",rules:[{required:!0}],children:e.jsxs(u,{disabled:i&&!c,children:[e.jsx(r,{value:"Superadmin",disabled:!c,children:"Superadmin"}),e.jsx(r,{value:"Admin",disabled:!c,children:"Admin"}),e.jsx(r,{value:"Team Leader",children:"Team Leader"}),e.jsx(r,{value:"Employee",children:"Employee"}),e.jsx(r,{value:"Client",disabled:i,children:"Client"})]})}),h==="Client"&&e.jsx(n.Item,{name:"businessAccount",label:"Business Account",rules:[{required:!0}],children:e.jsx(u,{placeholder:"Select Business",onChange:a=>{const s=E.find(t=>t._id===a);s&&d.setFieldsValue({name:s.contactName,email:s.contactEmail,mobile:s.contactNumber})},children:E.map(a=>e.jsx(r,{value:a._id,children:a.businessName},a._id))})}),e.jsx(n.Item,{name:"name",label:"Name",rules:[{required:!0}],children:e.jsx(C,{disabled:h==="Client"})}),e.jsx(n.Item,{name:"email",label:"Email",rules:[{required:!0,type:"email"}],children:e.jsx(C,{disabled:h==="Client"})}),e.jsx(n.Item,{name:"mobile",label:"Mobile",children:e.jsx(C,{disabled:h==="Client"})}),!i&&e.jsx(n.Item,{name:"password",label:"Password",rules:[{required:!0}],children:e.jsx(C.Password,{})}),h!=="Client"&&e.jsxs(e.Fragment,{children:[e.jsx(n.Item,{name:"department",label:"Department",children:e.jsx(u,{allowClear:!0,disabled:i&&!(p||c),children:_.map(a=>e.jsx(r,{value:a._id,children:a.name},a._id))})}),e.jsx(n.Item,{name:"team",label:"Team",children:e.jsx(u,{allowClear:!0,disabled:i&&!(p||c),children:T.map(a=>{var s;return e.jsxs(r,{value:a._id,children:[a.name," (",((s=a.department)==null?void 0:s.name)||"N/A",")"]},a._id)})})})]}),e.jsx(n.Item,{name:"status",label:"Status",rules:[{required:!0}],children:e.jsxs(u,{children:[e.jsx(r,{value:"Active",children:"Active"}),e.jsx(r,{value:"Inactive",children:"Inactive"})]})})]})}),e.jsx(U,{title:`Transfer User: ${y==null?void 0:y.name}`,open:L,onClose:()=>w(!1),width:420,destroyOnClose:!0,footer:e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx(o,{onClick:()=>w(!1),children:"Cancel"}),e.jsx(o,{type:"primary",onClick:X,children:"Transfer"})]}),children:e.jsxs(n,{form:A,layout:"vertical",children:[e.jsx(n.Item,{name:"newDepartment",label:"New Department",children:e.jsx(u,{placeholder:"Select Department",children:_.map(a=>e.jsx(r,{value:a._id,children:a.name},a._id))})}),e.jsx(n.Item,{name:"newTeam",label:"New Team",children:e.jsx(u,{placeholder:"Select Team",children:T.map(a=>{var s;return e.jsxs(r,{value:a._id,children:[a.name," (",((s=a.department)==null?void 0:s.name)||"N/A",")"]},a._id)})})})]})})]})};export{de as default};
