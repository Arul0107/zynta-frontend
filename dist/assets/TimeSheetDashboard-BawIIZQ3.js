import{r as i,x as a,O as L,B as S,V as n}from"./index-DysXtrl7.js";import{i as l}from"./axios-Dbq_CbWC.js";import{d as m}from"./dayjs.min-DoBvc7g8.js";import{F as d}from"./index-cDs3jJ7o.js";import{R as U}from"./row-BYIzmBXD.js";import{T as G}from"./index-PWcPX8J0.js";import{F as J}from"./Table-DflE-h7Z.js";import{M as K}from"./index-B0qVLxDy.js";import{I as Y}from"./index-N4YTd5WF.js";import{S as w}from"./index-qBajPA1p.js";import{D as q}from"./index-BVasZ5yH.js";import{P as z}from"./index-th8N7Gjr.js";import"./TextArea-Bqbh4RKI.js";import"./EditOutlined-C9Bhlaw5.js";import"./styleChecker-w1bbWMN2.js";import"./addEventListener-D04I5D8z.js";import"./index-BrgBQ01W.js";import"./Pagination-ByOtUXMd.js";import"./extendsObject-78o_rR5W.js";import"./InfoCircleFilled-6_sUPPXN.js";import"./ActionButton-C6N_UzTp.js";import"./index-1L-XTNt_.js";import"./useClosable-DxUighul.js";import"./context-DDkc41cA.js";const{Title:Q}=G,{TextArea:X}=Y,{Option:_}=w;function je(){const[T,p]=i.useState([]),[v,g]=i.useState(!1),[M,x]=i.useState(!1),[F,b]=i.useState(null),[k]=d.useForm(),[A,h]=i.useState({}),[f,y]=i.useState({}),[E,D]=i.useState([]),[O,N]=i.useState([]),u=JSON.parse(localStorage.getItem("user"))||{_id:"temp_id_123",name:"Guest User",role:"Employee",email:"guest@example.com"},I=["Admin","Superadmin"].includes(u.role),W=async()=>{try{const[t,e]=await Promise.all([l.get("/api/accounts"),l.get("/api/service")]);D(t.data||[]),N(e.data||[])}catch{n.error("Failed to fetch accounts or services")}},H=t=>{const e=Math.floor(Math.abs(t)/3600),o=Math.floor(Math.abs(t)%3600/60),s=Math.floor(Math.abs(t)%60);return`${t<0?"+":""}${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},R=t=>{if(!t)return"";const e=Math.floor(t*3600),o=Math.floor(e/3600),s=Math.floor(e%3600/60),r=e%60;return`${o}h ${s}m ${r}s`},$=async()=>{try{let t;if(I){t=await l.get("/api/work-sessions/today");const e=(t.data.sessions||[]).map(r=>({key:r._id,...r,loginTimeFormatted:m(r.loginTime).format("hh:mm:ss A"),logoutTimeFormatted:r.logoutTime?m(r.logoutTime).format("hh:mm:ss A"):""}));p(e);const o={},s={};e.forEach(r=>{const c=r.totalHours?Math.floor(r.totalHours*3600):0;o[r.key]=r.logoutTime?c:Math.floor(8*3600-(Date.now()-new Date(r.loginTime).getTime())/1e3),s[r.key]=!r.logoutTime}),h(o),y(s)}else if(t=await l.get(`/api/work-sessions/today/${u._id}`),t.data.session){const e=t.data.session,o={key:e._id,...e,loginTimeFormatted:m(e.loginTime).format("hh:mm:ss A"),logoutTimeFormatted:e.logoutTime?m(e.logoutTime).format("hh:mm:ss A"):""};p([o]),h({[o.key]:e.logoutTime?Math.floor(e.totalHours*3600):Math.floor(8*3600-(Date.now()-new Date(e.loginTime).getTime())/1e3)}),y({[o.key]:!e.logoutTime})}}catch{n.error("Failed to fetch sessions")}};i.useEffect(()=>{W(),$()},[]),i.useEffect(()=>{const t=setInterval(()=>{h(e=>{const o={};return Object.keys(e).forEach(s=>{o[s]=f[s]?e[s]-1:e[s]}),o})},1e3);return()=>clearInterval(t)},[f]);const V=async()=>{var t,e;g(!0);try{const s=(await l.post("/api/work-sessions/start",{userId:u._id,name:u.name,email:u.email})).data.session;p([{key:s._id,...s,loginTimeFormatted:m(s.loginTime).format("hh:mm:ss A"),logoutTimeFormatted:""}]),h({[s._id]:8*3600}),y({[s._id]:!0}),n.success("Work started successfully!")}catch(o){n.error(((e=(t=o.response)==null?void 0:t.data)==null?void 0:e.message)||"Failed to start work")}finally{g(!1)}},C=async t=>{var e,o;g(!0);try{const r=(await l.post("/api/work-sessions/stop",{sessionId:t})).data.session;p(c=>c.map(j=>j.key===t?{...j,logoutTimeFormatted:m(r.logoutTime).format("hh:mm:ss A"),totalHours:r.totalHours}:j)),y(c=>({...c,[t]:!1})),h(c=>({...c,[t]:Math.floor(r.totalHours*3600)})),n.success("Work stopped successfully!")}catch(s){n.error(((o=(e=s.response)==null?void 0:e.data)==null?void 0:o.message)||"Failed to stop work")}finally{g(!1)}},P=async t=>{try{await l.post("/api/work-sessions/eod",{sessionId:F.key,eod:t.eod,accountIds:t.accountIds,serviceIds:t.serviceIds,date:t.date?t.date.toISOString():null}),p(e=>e.map(o=>o.key===F.key?{...o,eod:t.eod,accountIds:t.accountIds,serviceIds:t.serviceIds,date:t.date?t.date.toISOString():o.date}:o)),x(!1),k.resetFields(),n.success("EOD saved!")}catch{n.error("Failed to save EOD")}},B=[{title:"Name",dataIndex:"name"},{title:"Login Time",dataIndex:"loginTimeFormatted"},{title:"Logout Time",dataIndex:"logoutTimeFormatted"},{title:"Timer",render:(t,e)=>a.jsx("span",{className:f[e.key]?"countdown":"overtime",children:H(A[e.key]||0)})},{title:"Worked Hours",dataIndex:"totalHours",render:(t,e)=>R(e.totalHours)},{title:"Accounts",render:(t,e)=>{var o;return((o=e.accountIds)==null?void 0:o.map(s=>s.businessName).join(", "))||"-"}},{title:"Services",render:(t,e)=>{var o;return((o=e.serviceIds)==null?void 0:o.map(s=>s.serviceName||s.name).join(", "))||"-"}},{title:"EOD",render:(t,e)=>a.jsx(S,{type:"link",onClick:()=>{b(e),x(!0),k.setFieldsValue({eod:e.eod||"",accountIds:e.accountIds||[],serviceIds:e.serviceIds||[],date:e.date?m(e.date):null})},children:e.eod?"View/Edit":"Add"})},{title:"Actions",render:(t,e)=>{const o=f[e.key],s=e.userId===u._id;return o&&(I||s)?a.jsx(z,{title:"Are you sure you want to stop work?",onConfirm:()=>C(e.key),okText:"Yes",cancelText:"No",children:a.jsx(S,{type:"danger",children:"Stop Work"})}):null}}];return a.jsxs("div",{style:{padding:24},children:[a.jsx(L,{position:"top-right",reverseOrder:!1}),a.jsxs(U,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[a.jsx(Q,{level:2,children:"Timesheet Dashboard"}),!I&&(!T[0]||!f[T[0].key])&&a.jsx(S,{type:"primary",loading:v,onClick:V,children:"Start Work"})]}),a.jsx(J,{columns:B,dataSource:T,pagination:!1,rowKey:"key"}),a.jsx(K,{title:"End of Day Notes",open:M,onCancel:()=>x(!1),footer:null,children:a.jsxs(d,{form:k,layout:"vertical",onFinish:P,children:[a.jsx(d.Item,{label:"EOD Message",name:"eod",children:a.jsx(X,{rows:4})}),a.jsx(d.Item,{label:"Select Accounts",name:"accountIds",children:a.jsx(w,{mode:"multiple",placeholder:"Select accounts",children:E.map(t=>a.jsx(_,{value:t._id,children:t.businessName},t._id))})}),a.jsx(d.Item,{label:"Select Services",name:"serviceIds",children:a.jsx(w,{mode:"multiple",placeholder:"Select services",children:O.map(t=>a.jsx(_,{value:t._id,children:t.serviceName||t.name},t._id))})}),a.jsx(d.Item,{label:"Date",name:"date",children:a.jsx(q,{style:{width:"100%"}})}),a.jsx(d.Item,{children:a.jsx(S,{type:"primary",htmlType:"submit",children:"Save"})})]})})]})}export{je as default};
