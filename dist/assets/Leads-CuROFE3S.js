import{r as n,x as s,y as Y,B as A,S as Te,H as c,as as Ae,at as S}from"./index-DysXtrl7.js";import{i as b}from"./axios-Dbq_CbWC.js";import{h as Ne,E as $e,R as ke}from"./html2canvas.esm-B6o5izMP.js";import{u as O,a as Ie}from"./xlsx-CyWl6TWy.js";import{R as Le,a as Fe,B as Ee,N as Re,F as ze,b as De}from"./FollowUpDrawer-UDFt6CS3.js";import{C as Pe}from"./index-IahplJ7o.js";import{I as K}from"./index-N4YTd5WF.js";import{R as J}from"./TextArea-Bqbh4RKI.js";import{R as Ue}from"./PlusOutlined-BIwFneT8.js";import{T as Z}from"./index-CL3JxQbZ.js";import{F as Oe}from"./Table-DflE-h7Z.js";import{E as _e}from"./index-qBajPA1p.js";import{M as Be}from"./index-B0qVLxDy.js";import{T as Ve}from"./index-PWcPX8J0.js";import{T as X}from"./index-BBTWRX9T.js";import{R as Me}from"./EditOutlined-C9Bhlaw5.js";import{R as Ge}from"./MessageOutlined-BZo189Jp.js";import{P as Qe}from"./index-th8N7Gjr.js";import{R as We}from"./DeleteOutlined-ine2ZxG6.js";import"./index-cDs3jJ7o.js";import"./row-BYIzmBXD.js";import"./index-BYWlwTeH.js";import"./context-DDkc41cA.js";import"./useClosable-DxUighul.js";import"./extendsObject-78o_rR5W.js";import"./MinusCircleOutlined-B9O64eBj.js";import"./index-0wDzc6vO.js";import"./index-CWHtsAdS.js";import"./moment-C5S46NFB.js";import"./index-BVasZ5yH.js";import"./dayjs.min-DoBvc7g8.js";import"./index-DVuuwvNm.js";import"./Pagination-ByOtUXMd.js";import"./styleChecker-w1bbWMN2.js";import"./addEventListener-D04I5D8z.js";import"./index-BrgBQ01W.js";import"./InfoCircleFilled-6_sUPPXN.js";import"./ActionButton-C6N_UzTp.js";import"./index-1L-XTNt_.js";const{Title:qe}=Ve,{TabPane:C}=Z,N="/api/accounts",Rt=()=>{const[ee,k]=n.useState(!1),[E,_]=n.useState(null),[u,te]=n.useState(""),[m,se]=n.useState("all"),[ae,R]=n.useState(!1),[B,z]=n.useState(null),[D,P]=n.useState(null),[I,re]=n.useState([]),[oe,V]=n.useState(!1),[ne,M]=n.useState(!1),[U,G]=n.useState(null),[f,ce]=n.useState({}),[o,$]=n.useState({current:1,pageSize:10,total:0}),[x,ie]=n.useState({all:0,active:0,customers:0,Pipeline:0,closed:0,quotations:0,TargetLeads:0}),[le,ue]=n.useState([]),[de,Q]=n.useState(!1),[pe,W]=n.useState(!0),v=JSON.parse(localStorage.getItem("user")),l=v==null?void 0:v.role,d=v==null?void 0:v._id,q=n.useRef(null),me=async()=>{Q(!0);try{const e=await b.get("/api/accounts/users");ue(e.data)}catch(e){console.error("Error fetching users:",e),c.error("Failed to load users for assignment.")}finally{Q(!1)}},j=async()=>{try{let e=`${N}/counts`;l==="Employee"&&d?e+=`?userId=${d}&role=${l}`:l==="Team Leader"&&d&&(e+=`?teamLeaderId=${d}&role=${l}`);const t=await b.get(e);ie(t.data)}catch(e){c.error("Failed to fetch tab counts."),console.error("Fetch counts error:",e)}},h=async(e={})=>{W(!0);try{const{current:t=o.current,pageSize:a=o.pageSize,searchText:r="",activeTab:i="all",sortBy:w="createdAt",sortOrder:p="desc",filters:g=f}=e,T=i==="all"?"":i;let y=`${N}/paginated?page=${t}&pageSize=${a}&search=${r}`;T&&(y+=`&status=${T}`),w&&(y+=`&sortBy=${w}`),p&&(y+=`&sortOrder=${p}`),Object.keys(g).forEach(F=>{g[F]&&g[F].length>0&&(y+=`&${F}=${g[F].join(",")}`)}),l==="Employee"&&d?y+=`&userId=${d}&role=${l}`:l==="Team Leader"&&d&&(y+=`&teamLeaderId=${d}&role=${l}`);const L=await b.get(y);re(L.data.data),$({...o,current:L.data.page,pageSize:L.data.pageSize,total:L.data.total})}catch(t){c.error("Failed to fetch accounts."),console.error("Fetch accounts error:",t)}finally{W(!1)}};n.useEffect(()=>{if(o.current!==1){$(e=>({...e,current:1}));return}h({current:1,pageSize:o.pageSize,searchText:u,activeTab:m,filters:f}),me()},[u,m,l,d]),n.useEffect(()=>{h({current:o.current,pageSize:o.pageSize,searchText:u,activeTab:m,filters:f})},[o.current,o.pageSize]),n.useEffect(()=>{j()},[l,d]);const ge=async e=>{var t;try{const a={...e};E?(await b.put(`${N}/${E._id}`,a),c.success("Account updated successfully!")):(await b.post(N,a),c.success("Account created successfully!")),k(!1),h({current:1,pageSize:o.pageSize,searchText:u,activeTab:m,filters:f}),j()}catch(a){throw a.response&&a.response.status===409||(c.error("Failed to save account."),console.error("Save account error:",((t=a.response)==null?void 0:t.data)||a.message)),a}},fe=e=>{_(e),k(!0)},he=async e=>{var t;try{await b.delete(`${N}/${e}`),c.success("Account status set to Closed!"),h({current:o.current,pageSize:o.pageSize,searchText:u,activeTab:m,filters:f}),j()}catch(a){c.error("Failed to set account status to Closed."),console.error("Delete account error:",((t=a.response)==null?void 0:t.data)||a.message)}},xe=e=>{G(e),V(!0)},ye=e=>{G(e),M(!0)},H=(e,t)=>{z(t),P(e),R(!0)},Se=async()=>{var e;try{const t={...B,status:D};await b.put(`${N}/${B._id}`,t),c.success(`Account status changed to ${D}!`),h({current:o.current,pageSize:o.pageSize,searchText:u,activeTab:m,filters:f}),j()}catch(t){c.error("Failed to update account status."),console.error("Status update error:",((e=t.response)==null?void 0:e.data)||t.message)}finally{R(!1),z(null),P(null)}},be=()=>{R(!1),z(null),P(null)},Ce=async()=>{const e=q.current;if(!e){c.error("Table content not found for PDF export.");return}c.loading("Generating PDF...",{id:"pdf-toast"});try{const t=await Ne(e,{scale:2}),a=t.toDataURL("image/png"),r=new $e("p","mm","a4"),i=210,w=297,p=t.height*i/t.width;let g=p,T=0;for(r.addImage(a,"PNG",0,T,i,p),g-=w;g>=0;)T=g-p,r.addPage(),r.addImage(a,"PNG",0,T,i,p),g-=w;r.save("Leads_Customers_Details.pdf"),c.success("PDF generated!",{id:"pdf-toast"})}catch(t){console.error("Error generating PDF:",t),c.error("Failed to generate PDF.",{id:"pdf-toast"})}},ve=()=>{if(I.length===0){c.error("No data to export to Excel.");return}const e=I.map((r,i)=>{var p;return{"S.No":i+1+(o.current-1)*o.pageSize,"Business Name":r.businessName,"Contact Name":r.contactName,Email:r.contactEmail,"Mobile Number":r.contactNumber,"Lead Type":r.typeOfLead&&r.typeOfLead.length>0?r.typeOfLead.join(", "):"N/A",Status:r.status,"Source Type":r.sourceType,"Assigned To":((p=r.assignedTo)==null?void 0:p.name)||"Unassigned","GST Number":r.gstNumber,"Phone Number (Alt)":r.contactNumber,"Address Line 1":r.addressLine1,"Address Line 2":r.addressLine2,City:r.city,Pincode:r.pincode,State:r.state,Country:r.country,Website:r.website,"Is Customer":r.isCustomer?"Yes":"No","Created At":new Date(r.createdAt).toLocaleString()}}),t=O.json_to_sheet(e),a=O.book_new();O.book_append_sheet(a,t,"Leads & Customers"),Ie(a,"Leads_Customers_Data.xlsx"),c.success("Data exported to Excel!")},je=[{title:"S.No",key:"sno",render:(e,t,a)=>a+1+(o.current-1)*o.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",key:"businessName",sorter:!0,filterDropdown:({setSelectedKeys:e,selectedKeys:t,confirm:a,clearFilters:r})=>s.jsxs("div",{style:{padding:8},children:[s.jsx(K,{placeholder:"Search Business Name",value:t[0],onChange:i=>e(i.target.value?[i.target.value]:[]),onPressEnter:()=>a(),style:{marginBottom:8,display:"block"}}),s.jsx(A,{type:"primary",onClick:()=>a(),icon:s.jsx(J,{}),size:"small",style:{width:90,marginRight:8,backgroundColor:"#0E2B43",borderColor:"orange",color:"white"},children:"Search"}),s.jsx(A,{onClick:()=>r(),size:"small",style:{width:90},children:"Reset"})]}),responsive:["xs","sm","md","lg"]},{title:"Contact Name",dataIndex:"contactName",key:"contactName",sorter:!0,responsive:["md","lg"]},{title:"Email",dataIndex:"contactEmail",key:"contactEmail",responsive:["lg"]},{title:"Service",dataIndex:"selectedService",key:"selectedService",render:e=>e?e.serviceName:"N/A",responsive:["md","lg"]},{title:"Contact Number",dataIndex:"contactNumber",key:"contactNumber",responsive:["md","lg"]},{title:"Type of Leads",dataIndex:"typeOfLead",key:"typeOfLead",render:e=>s.jsx(Y,{children:e&&e.map(t=>s.jsx(X,{color:"blue",children:t},t))}),filters:[{text:"Regular",value:"Regular"},{text:"Revenue",value:"Revenue"},{text:"Government",value:"Government"},{text:"Occupational",value:"Occupational"}],filterMultiple:!0,onFilter:(e,t)=>{var a;return(a=t.typeOfLead)==null?void 0:a.includes(e)},responsive:["lg"]},{title:"Status",dataIndex:"status",key:"status",render:e=>{let t;switch(e){case"Active":t="green";break;case"Pipeline":t="orange";break;case"Closed":t="purple";break;case"Customer":t="blue";break;case"Quotations":t="cyan";break;case"TargetLeads":t="gold";break;default:t="gray"}return s.jsx(X,{color:t,children:e})},filters:[{text:"Active",value:"Active"},{text:"Pipeline",value:"Pipeline"},{text:"Closed",value:"Closed"},{text:"Customer",value:"Customer"},{text:"Quotations",value:"Quotations"},{text:"Target Leads",value:"TargetLeads"}],filterMultiple:!0,responsive:["sm","md","lg"]},{title:"Assigned To",dataIndex:"assignedTo",key:"assignedTo",render:e=>e?e.name:"Unassigned",responsive:["md","lg"]},{title:"Source Type",dataIndex:"sourceType",key:"sourceType",filters:[{text:"Direct",value:"Direct"},{text:"Social Media",value:"socialmedia"},{text:"Website",value:"online"},{text:"Existing Client",value:"client"},{text:"Tradefair",value:"tradefair"},{text:"Other",value:"Other"}],onFilter:(e,t)=>t.sourceType===e,responsive:["lg"]},{title:"Action",key:"action",width:80,render:(e,t)=>s.jsx(Ae,{overlay:s.jsxs(S,{children:[s.jsx(S.Item,{icon:s.jsx(Me,{}),onClick:()=>fe(t),children:"Edit Account"},"edit"),s.jsx(S.Item,{icon:s.jsx(Ge,{}),onClick:()=>xe(t),children:"View/Add Notes"},"notes"),s.jsx(S.Item,{icon:s.jsx(De,{}),onClick:()=>ye(t),children:"View/Add Follow-ups"},"followup"),t.status==="Customer"?s.jsx(S.Item,{onClick:()=>H("Active",t),children:"Change to Lead"},"change-to-lead"):s.jsx(S.Item,{onClick:()=>H("Customer",t),children:"Change to Customer"},"change-to-customer"),(l==="Superadmin"||l==="Admin")&&s.jsx(S.Item,{children:s.jsxs(Qe,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>he(t._id),okText:"Yes",cancelText:"No",children:[s.jsx(We,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:s.jsx(A,{icon:s.jsx(ke,{})})})}],we=(e,t,a)=>{$(e);const r=a.field||"createdAt",i=a.order==="ascend"?"asc":a.order==="descend"?"desc":void 0;ce(t),h({current:e.current,pageSize:e.pageSize,searchText:u,activeTab:m,sortBy:r,sortOrder:i,filters:{status:t.status,sourceType:t.sourceType,typeOfLead:t.typeOfLead}})};return s.jsxs(Pe,{title:s.jsx(qe,{level:4,children:"Manage Leads & Customers"}),children:[s.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"10px"},children:[s.jsx(K,{placeholder:"Search by business or contact name",prefix:s.jsx(J,{}),style:{width:"100%",maxWidth:300},value:u,onChange:e=>{te(e.target.value),$({...o,current:1})}}),s.jsxs(Y,{children:[s.jsx(A,{type:"primary",icon:s.jsx(Ue,{}),style:{backgroundColor:"#0E2B43",borderColor:"orange",color:"white"},onClick:()=>{_(null),k(!0)},children:"Add New Account"}),s.jsx(A,{icon:s.jsx(Le,{}),onClick:Ce}),s.jsx(A,{icon:s.jsx(Fe,{}),onClick:ve})]})]}),s.jsxs(Z,{defaultActiveKey:"all",onChange:e=>{se(e),$({...o,current:1})},children:[s.jsx(C,{tab:`All Leads (${x.all||0})`},"all"),s.jsx(C,{tab:`Target Leads (${x.targetLeads||0})`},"TargetLeads"),s.jsx(C,{tab:`Lead (${x.active||0})`},"Active"),s.jsx(C,{tab:`Enquiry (${x.Pipeline||0})`},"Pipeline"),s.jsx(C,{tab:`Quotations Sent (${x.quotations||0})`},"Quotations"),s.jsx(C,{tab:`Converted (${x.customers||0})`},"Customer"),s.jsx(C,{tab:`Closed Accounts (${x.closed||0})`},"Closed")]}),s.jsx("div",{ref:q,children:pe?s.jsx(Te,{size:"large",style:{display:"block",margin:"50px auto"}}):I.length>0?s.jsx(Oe,{columns:je,dataSource:I,rowKey:"_id",scroll:{x:"max-content"},pagination:o,onChange:we}):s.jsx(_e,{description:"No accounts found."})}),s.jsx(Ee,{visible:ee,onClose:()=>k(!1),onSave:ge,initialValues:E,allUsers:le,loadingUsers:de}),U&&s.jsxs(s.Fragment,{children:[s.jsx(Re,{visible:oe,onClose:()=>V(!1),account:U,refreshAccounts:()=>{h({current:o.current,pageSize:o.pageSize,searchText:u,activeTab:m,filters:f}),j()}}),s.jsx(ze,{visible:ne,onClose:()=>M(!1),account:U,refreshAccounts:()=>{h({current:o.current,pageSize:o.pageSize,searchText:u,activeTab:m,filters:f}),j()}})]}),s.jsx(Be,{title:"Change Account Status",open:ae,onOk:Se,onCancel:be,okText:"Yes",cancelText:"No",children:s.jsxs("p",{children:["Are you sure you want to change this account's status to"," ","**",D,"**?"]})})]})};export{Rt as default};
