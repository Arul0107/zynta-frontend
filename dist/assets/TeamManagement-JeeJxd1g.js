import{r as i,I as Q,e as W,x as r,B as m,E as X,y as Z,V as o}from"./index-DysXtrl7.js";import{i as y}from"./axios-Dbq_CbWC.js";import{F as l}from"./index-cDs3jJ7o.js";import{R as U}from"./PlusOutlined-BIwFneT8.js";import{C as D}from"./Collapse-DoHxGrQW.js";import{L as S}from"./index-DVuuwvNm.js";import{R as ee}from"./SwapOutlined-CUC4v0id.js";import{R as re}from"./TeamOutlined-BaT0KEBz.js";import{R as te}from"./EditOutlined-C9Bhlaw5.js";import{P as ae}from"./index-th8N7Gjr.js";import{R as se}from"./DeleteOutlined-ine2ZxG6.js";import{D as V}from"./index-BYWlwTeH.js";import{I as ne}from"./index-N4YTd5WF.js";import{S as c}from"./index-qBajPA1p.js";import"./row-BYIzmBXD.js";import"./TextArea-Bqbh4RKI.js";import"./extendsObject-78o_rR5W.js";import"./Pagination-ByOtUXMd.js";import"./ActionButton-C6N_UzTp.js";import"./context-DDkc41cA.js";import"./useClosable-DxUighul.js";var le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M908 640H804V488c0-4.4-3.6-8-8-8H548v-96h108c8.8 0 16-7.2 16-16V80c0-8.8-7.2-16-16-16H368c-8.8 0-16 7.2-16 16v288c0 8.8 7.2 16 16 16h108v96H228c-4.4 0-8 3.6-8 8v152H116c-8.8 0-16 7.2-16 16v288c0 8.8 7.2 16 16 16h288c8.8 0 16-7.2 16-16V656c0-8.8-7.2-16-16-16H292v-88h440v88H620c-8.8 0-16 7.2-16 16v288c0 8.8 7.2 16 16 16h288c8.8 0 16-7.2 16-16V656c0-8.8-7.2-16-16-16zm-564 76v168H176V716h168zm84-408V140h168v168H428zm420 576H680V716h168v168z"}}]},name:"apartment",theme:"outlined"},oe=function(p,j){return i.createElement(Q,W({},p,{ref:j,icon:le}))},ie=i.forwardRef(oe);const{Option:x}=c,{Panel:$}=D,Re=({teams:C,departments:p,allUsers:j,fetchTeams:b,fetchDepartments:me,fetchUsers:v})=>{const[z,h]=i.useState(!1),[n,L]=i.useState(null),[g]=l.useForm(),[A,w]=i.useState(!1),[u,F]=i.useState(null),[f]=l.useForm(),[R,T]=i.useState([]),d=JSON.parse(localStorage.getItem("user")),I=(d==null?void 0:d.role)==="Superadmin",_=(d==null?void 0:d.role)==="Admin",k=j.filter(e=>e.role==="Team Leader"&&!e.team),O=j.filter(e=>e.role==="Employee"&&!e.team),H=i.useCallback(()=>{const e=n==null?void 0:n.teamLeader;let t=[...k];return e&&!t.some(a=>a._id===e._id)&&t.push(e),t.sort((a,s)=>a.name.localeCompare(s.name))},[n,k]),N=i.useCallback(()=>{const e=(n==null?void 0:n.members)||[];let t=[...O];return e.forEach(a=>{t.some(s=>s._id===a._id)||t.push(a)}),t.sort((a,s)=>a.name.localeCompare(s.name))},[n,O]),M=()=>{L(null),g.resetFields(),h(!0)},P=e=>{var t,a;L(e),g.setFieldsValue({name:e.name,department:(t=e.department)==null?void 0:t._id,teamLeader:(a=e.teamLeader)==null?void 0:a._id,members:e.members.map(s=>s._id)}),h(!0)},q=async()=>{var e,t;try{const a=await g.validateFields();n?(await y.put(`/api/teams/${n._id}`,a),o.success("Team updated successfully")):(await y.post("/api/teams",a),o.success("Team created successfully")),h(!1),b(),v()}catch(a){console.error("Team submission failed:",a),o.error(((t=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to submit team.")}},J=async e=>{var t,a;try{await y.delete(`/api/teams/${e}`),o.success("Team deleted"),b(),v()}catch(s){console.error("Team deletion failed:",s),o.error(((a=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to delete team.")}},E=p.reduce((e,t)=>(e[t._id]={...t,teams:C.filter(a=>{var s;return((s=a.department)==null?void 0:s._id)===t._id})},e),{}),K=e=>{F(e),f.resetFields(),T([]),w(!0)},Y=e=>{if(f.setFieldsValue({newTeamId:void 0}),e){const t=C.filter(a=>{var s;return((s=a.department)==null?void 0:s._id)===e});T(t)}else T([])},G=async()=>{var e,t;try{const a=await f.validateFields(),{newDepartmentId:s,newTeamId:B}=a;if(!u){o.error("No user selected for transfer.");return}if(!s&&!B){o.error("Please select a new department or team for transfer.");return}await y.put(`/api/users/${u._id}/transfer`,{newDepartmentId:s||null,newTeamId:B||null}),o.success(`${u.name} transferred successfully.`),w(!1),F(null),v(),b()}catch(a){console.error("User transfer failed:",a),o.error(((t=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to transfer user.")}};return r.jsxs(r.Fragment,{children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[r.jsx("h2",{children:"Team Management"}),(I||_)&&r.jsx(m,{type:"primary",style:{backgroundColor:"#0E2B43",borderColor:"#orange",color:"white"},icon:r.jsx(U,{}),onClick:M,children:"Create Team"})]}),r.jsx(D,{accordion:!0,bordered:!1,defaultActiveKey:Object.keys(E)[0],children:Object.values(E).map(e=>r.jsx($,{header:r.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[r.jsx(ie,{style:{marginRight:8,fontSize:"1.2em"}}),r.jsxs("h3",{children:[e.name," (",e.teams.length," Teams)"]})]}),style:{marginBottom:10,borderRadius:8,overflow:"hidden",border:"1px solid #d9d9d9"},children:e.teams.length===0?r.jsx("p",{children:"No teams in this department."}):r.jsx(D,{accordion:!0,bordered:!1,style:{background:"#f0f2f5"},children:e.teams.map(t=>r.jsx($,{header:r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[r.jsx(re,{style:{marginRight:8}}),r.jsx("strong",{children:t.name}),t.teamLeader&&r.jsxs("span",{style:{marginLeft:15,fontSize:"0.9em",color:"#555"},children:["(Leader: ",t.teamLeader.name,")"]})]}),(I||_)&&r.jsxs(Z,{onClick:a=>a.stopPropagation(),children:[" ",r.jsx(m,{icon:r.jsx(te,{}),onClick:()=>P(t),size:"small",title:"Edit Team"}),r.jsx(ae,{title:"Delete this team?",onConfirm:()=>J(t._id),okText:"Yes",cancelText:"No",children:r.jsx(m,{danger:!0,icon:r.jsx(se,{}),size:"small",title:"Delete Team"})})]})]}),style:{marginBottom:5,borderRadius:6,border:"1px solid #e8e8e8"},children:r.jsxs("div",{style:{paddingLeft:20},children:[r.jsx("h4",{children:"Team Members:"}),t.members.length===0?r.jsx("p",{children:"No members in this team."}):r.jsx(S,{size:"small",dataSource:t.members,renderItem:a=>r.jsx(S.Item,{actions:[(I||_)&&r.jsx(m,{type:"link",icon:r.jsx(ee,{}),onClick:()=>K(a),size:"small",title:"Transfer User",children:"Transfer"})],children:r.jsx(S.Item.Meta,{avatar:r.jsx(X,{}),title:a.name,description:a.email})})})]})},t._id))})},e._id))}),r.jsx(V,{title:n?"Edit Team":"Create Team",open:z,onClose:()=>h(!1),width:420,destroyOnClose:!0,footer:r.jsxs("div",{style:{textAlign:"right"},children:[r.jsx(m,{onClick:()=>h(!1),style:{marginRight:8},children:"Cancel"}),r.jsx(m,{type:"primary",style:{backgroundColor:"#0E2B43",borderColor:"#orange",color:"white"},onClick:q,children:n?"Update":"Create"})]}),children:r.jsxs(l,{form:g,layout:"vertical",children:[r.jsx(l.Item,{name:"name",label:"Team Name",rules:[{required:!1,message:"Team name is required"}],children:r.jsx(ne,{placeholder:"Enter team name"})}),r.jsx(l.Item,{name:"department",label:"Department",rules:[{required:!0,message:"Please select a department"}],children:r.jsx(c,{placeholder:"Select department",children:p.map(e=>r.jsx(x,{value:e._id,children:e.name},e._id))})}),r.jsx(l.Item,{name:"teamLeader",label:"Team Leader",children:r.jsx(c,{placeholder:"Select team leader (optional)",allowClear:!0,showSearch:!0,filterOption:(e,t)=>t.children[0].toLowerCase().includes(e.toLowerCase()),children:H().map(e=>r.jsxs(x,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})}),r.jsx(l.Item,{name:"members",label:"Team Members",children:r.jsx(c,{mode:"multiple",placeholder:"Select team members (optional)",showSearch:!0,filterOption:(e,t)=>t.children[0].toLowerCase().includes(e.toLowerCase()),children:N().map(e=>r.jsxs(x,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})})]})}),r.jsx(V,{title:`Transfer ${u?u.name:"User"}`,open:A,onClose:()=>w(!1),width:420,destroyOnClose:!0,footer:r.jsxs("div",{style:{textAlign:"right"},children:[r.jsx(m,{onClick:()=>w(!1),style:{marginRight:8},children:"Cancel"}),r.jsx(m,{type:"primary",style:{backgroundColor:"#0E2B43",borderColor:"#orange",color:"white"},onClick:G,children:"Transfer"})]}),children:r.jsxs(l,{form:f,layout:"vertical",children:[r.jsx(l.Item,{name:"newDepartmentId",label:"New Department",children:r.jsx(c,{placeholder:"Select new department (optional)",allowClear:!0,onChange:Y,showSearch:!0,filterOption:(e,t)=>t.children.toLowerCase().includes(e.toLowerCase()),children:p.map(e=>r.jsx(x,{value:e._id,children:e.name},e._id))})}),r.jsx(l.Item,{name:"newTeamId",label:"New Team",children:r.jsx(c,{placeholder:"Select new team (optional)",allowClear:!0,showSearch:!0,filterOption:(e,t)=>t.children.toLowerCase().includes(e.toLowerCase()),disabled:!f.getFieldValue("newDepartmentId")||R.length===0,children:R.map(e=>r.jsx(x,{value:e._id,children:e.name},e._id))})})]})})]})};export{Re as default};
