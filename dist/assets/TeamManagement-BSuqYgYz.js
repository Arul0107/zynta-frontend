import{q as a,s as w,V as i}from"./index-Db3Ct3vh.js";import{r as d,F as l,B as o,q as Q,av as S,L as v,aw as W,S as X,y as Z,P as U,a as ee,D as $,c as ae,l as m}from"./antd-CjRtIVzR.js";import{e as se,C as re,a0 as te}from"./icons-De3RWgvB.js";import"./react-DoC2WAmd.js";const{Option:f}=m,{Panel:N}=S,ce=({teams:_,departments:g,allUsers:D,fetchTeams:y,fetchDepartments:ne,fetchUsers:C})=>{const[A,u]=d.useState(!1),[n,L]=d.useState(null),[x]=l.useForm(),[z,j]=d.useState(!1),[h,F]=d.useState(null),[p]=l.useForm(),[k,b]=d.useState([]),c=JSON.parse(localStorage.getItem("user")),T=(c==null?void 0:c.role)==="Superadmin",I=(c==null?void 0:c.role)==="Admin",E=D.filter(e=>e.role==="Team Leader"&&!e.team),O=D.filter(e=>e.role==="Employee"&&!e.team),M=d.useCallback(()=>{const e=n==null?void 0:n.teamLeader;let s=[...E];return e&&!s.some(r=>r._id===e._id)&&s.push(e),s.sort((r,t)=>r.name.localeCompare(t.name))},[n,E]),P=d.useCallback(()=>{const e=(n==null?void 0:n.members)||[];let s=[...O];return e.forEach(r=>{s.some(t=>t._id===r._id)||s.push(r)}),s.sort((r,t)=>r.name.localeCompare(t.name))},[n,O]),q=()=>{L(null),x.resetFields(),u(!0)},V=e=>{var s,r;L(e),x.setFieldsValue({name:e.name,department:(s=e.department)==null?void 0:s._id,teamLeader:(r=e.teamLeader)==null?void 0:r._id,members:e.members.map(t=>t._id)}),u(!0)},J=async()=>{var e,s;try{const r=await x.validateFields();n?(await w.put(`/api/teams/${n._id}`,r),i.success("Team updated successfully")):(await w.post("/api/teams",r),i.success("Team created successfully")),u(!1),y(),C()}catch(r){console.error("Team submission failed:",r),i.error(((s=(e=r==null?void 0:r.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to submit team.")}},K=async e=>{var s,r;try{await w.delete(`/api/teams/${e}`),i.success("Team deleted"),y(),C()}catch(t){console.error("Team deletion failed:",t),i.error(((r=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:r.message)||"Failed to delete team.")}},R=g.reduce((e,s)=>(e[s._id]={...s,teams:_.filter(r=>{var t;return((t=r.department)==null?void 0:t._id)===s._id})},e),{}),Y=e=>{F(e),p.resetFields(),b([]),j(!0)},G=e=>{if(p.setFieldsValue({newTeamId:void 0}),e){const s=_.filter(r=>{var t;return((t=r.department)==null?void 0:t._id)===e});b(s)}else b([])},H=async()=>{var e,s;try{const r=await p.validateFields(),{newDepartmentId:t,newTeamId:B}=r;if(!h){i.error("No user selected for transfer.");return}if(!t&&!B){i.error("Please select a new department or team for transfer.");return}await w.put(`/api/users/${h._id}/transfer`,{newDepartmentId:t||null,newTeamId:B||null}),i.success(`${h.name} transferred successfully.`),j(!1),F(null),C(),y()}catch(r){console.error("User transfer failed:",r),i.error(((s=(e=r==null?void 0:r.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to transfer user.")}};return a.jsxs(a.Fragment,{children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[a.jsx("h2",{children:"Team Management"}),(T||I)&&a.jsx(o,{type:"primary",style:{backgroundColor:"#0E2B43",borderColor:"#orange",color:"white"},icon:a.jsx(Q,{}),onClick:q,children:"Create Team"})]}),a.jsx(S,{accordion:!0,bordered:!1,defaultActiveKey:Object.keys(R)[0],children:Object.values(R).map(e=>a.jsx(N,{header:a.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[a.jsx(te,{style:{marginRight:8,fontSize:"1.2em"}}),a.jsxs("h3",{children:[e.name," (",e.teams.length," Teams)"]})]}),style:{marginBottom:10,borderRadius:8,overflow:"hidden",border:"1px solid #d9d9d9"},children:e.teams.length===0?a.jsx("p",{children:"No teams in this department."}):a.jsx(S,{accordion:!0,bordered:!1,style:{background:"#f0f2f5"},children:e.teams.map(s=>a.jsx(N,{header:a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[a.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[a.jsx(re,{style:{marginRight:8}}),a.jsx("strong",{children:s.name}),s.teamLeader&&a.jsxs("span",{style:{marginLeft:15,fontSize:"0.9em",color:"#555"},children:["(Leader: ",s.teamLeader.name,")"]})]}),(T||I)&&a.jsxs(X,{onClick:r=>r.stopPropagation(),children:[" ",a.jsx(o,{icon:a.jsx(Z,{}),onClick:()=>V(s),size:"small",title:"Edit Team"}),a.jsx(U,{title:"Delete this team?",onConfirm:()=>K(s._id),okText:"Yes",cancelText:"No",children:a.jsx(o,{danger:!0,icon:a.jsx(ee,{}),size:"small",title:"Delete Team"})})]})]}),style:{marginBottom:5,borderRadius:6,border:"1px solid #e8e8e8"},children:a.jsxs("div",{style:{paddingLeft:20},children:[a.jsx("h4",{children:"Team Members:"}),s.members.length===0?a.jsx("p",{children:"No members in this team."}):a.jsx(v,{size:"small",dataSource:s.members,renderItem:r=>a.jsx(v.Item,{actions:[(T||I)&&a.jsx(o,{type:"link",icon:a.jsx(W,{}),onClick:()=>Y(r),size:"small",title:"Transfer User",children:"Transfer"})],children:a.jsx(v.Item.Meta,{avatar:a.jsx(se,{}),title:r.name,description:r.email})})})]})},s._id))})},e._id))}),a.jsx($,{title:n?"Edit Team":"Create Team",open:A,onClose:()=>u(!1),width:420,destroyOnClose:!0,footer:a.jsxs("div",{style:{textAlign:"right"},children:[a.jsx(o,{onClick:()=>u(!1),style:{marginRight:8},children:"Cancel"}),a.jsx(o,{type:"primary",style:{backgroundColor:"#0E2B43",borderColor:"#orange",color:"white"},onClick:J,children:n?"Update":"Create"})]}),children:a.jsxs(l,{form:x,layout:"vertical",children:[a.jsx(l.Item,{name:"name",label:"Team Name",rules:[{required:!1,message:"Team name is required"}],children:a.jsx(ae,{placeholder:"Enter team name"})}),a.jsx(l.Item,{name:"department",label:"Department",rules:[{required:!0,message:"Please select a department"}],children:a.jsx(m,{placeholder:"Select department",children:g.map(e=>a.jsx(f,{value:e._id,children:e.name},e._id))})}),a.jsx(l.Item,{name:"teamLeader",label:"Team Leader",children:a.jsx(m,{placeholder:"Select team leader (optional)",allowClear:!0,showSearch:!0,filterOption:(e,s)=>s.children[0].toLowerCase().includes(e.toLowerCase()),children:M().map(e=>a.jsxs(f,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})}),a.jsx(l.Item,{name:"members",label:"Team Members",children:a.jsx(m,{mode:"multiple",placeholder:"Select team members (optional)",showSearch:!0,filterOption:(e,s)=>s.children[0].toLowerCase().includes(e.toLowerCase()),children:P().map(e=>a.jsxs(f,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})})]})}),a.jsx($,{title:`Transfer ${h?h.name:"User"}`,open:z,onClose:()=>j(!1),width:420,destroyOnClose:!0,footer:a.jsxs("div",{style:{textAlign:"right"},children:[a.jsx(o,{onClick:()=>j(!1),style:{marginRight:8},children:"Cancel"}),a.jsx(o,{type:"primary",style:{backgroundColor:"#0E2B43",borderColor:"#orange",color:"white"},onClick:H,children:"Transfer"})]}),children:a.jsxs(l,{form:p,layout:"vertical",children:[a.jsx(l.Item,{name:"newDepartmentId",label:"New Department",children:a.jsx(m,{placeholder:"Select new department (optional)",allowClear:!0,onChange:G,showSearch:!0,filterOption:(e,s)=>s.children.toLowerCase().includes(e.toLowerCase()),children:g.map(e=>a.jsx(f,{value:e._id,children:e.name},e._id))})}),a.jsx(l.Item,{name:"newTeamId",label:"New Team",children:a.jsx(m,{placeholder:"Select new team (optional)",allowClear:!0,showSearch:!0,filterOption:(e,s)=>s.children.toLowerCase().includes(e.toLowerCase()),disabled:!p.getFieldValue("newDepartmentId")||k.length===0,children:k.map(e=>a.jsx(f,{value:e._id,children:e.name},e._id))})})]})})]})};export{ce as default};
