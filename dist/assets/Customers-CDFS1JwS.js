import{r as n,U as ue,x as e,y as me,B as D,S as pe,H as i,as as ge,at as S}from"./index-Dx0fORvq.js";import{i as y}from"./axios-By3bUnR1.js";import{R as he,a as fe,B as xe,F as Se,N as ye,b as Ce}from"./FollowUpDrawer-Cand-lGa.js";import{h as je,E as be,R as we}from"./html2canvas.esm-BSE4e0vj.js";import{u as F,a as Te}from"./xlsx-CyWl6TWy.js";import{C as Ne}from"./index-C1eVaR1v.js";import{R as Ie,C as _}from"./row-D7mQAf0A.js";import{T as Ee}from"./index-DkVdE_3I.js";import{I as $e}from"./index-CycGH6gG.js";import{R as Ae}from"./TextArea-Bqwst6Wg.js";import{F as ze}from"./Table-BFHR8fXI.js";import{E as De}from"./index-Bcd2XmZI.js";import{M as Fe}from"./index-Cdvz5H4l.js";import{T as b}from"./index-BGnsSyBi.js";import{R as _e}from"./EditOutlined--TcujLaX.js";import{R as ke}from"./MessageOutlined-B6KeS4ko.js";import{P as ve}from"./index-D4CZw55Y.js";import{R as Le}from"./DeleteOutlined-DlHM_4f9.js";import{T as Re}from"./index-CGWGFuT9.js";import"./index-BHKMv-_S.js";import"./ExclamationCircleFilled-ctPYYyzk.js";import"./index-C3OeHxcS.js";import"./context-LTZAWJIx.js";import"./useClosable-D6ihuouj.js";import"./extendsObject-78o_rR5W.js";import"./MinusCircleOutlined-CncFMDVt.js";import"./PlusOutlined-Dt2q3nHd.js";import"./index-DmCauXk3.js";import"./index-toTrP2vq.js";import"./moment-C5S46NFB.js";import"./index-gtlyNNxV.js";import"./index-D5gtJ-xG.js";import"./Pagination-9G_nljkd.js";import"./styleChecker-BIxzM-w-.js";import"./addEventListener-CZDGFXVg.js";import"./index-Bq5jwgzS.js";import"./InfoCircleFilled-CGhkVSDg.js";import"./ActionButton-DcYFGn3W.js";import"./index-o4REvhBZ.js";const{Title:Be}=Ee,{TabPane:Nt}=Re,w="/api/accounts",It=()=>{const[d,O]=n.useState(""),[T,M]=n.useState([]),[k,m]=n.useState(!1),[H,G]=n.useState([]),[W,v]=n.useState(!1),[Y,N]=n.useState(!1),[p,L]=n.useState(null),[J,I]=n.useState(!1),[C,R]=n.useState(null),[E,B]=n.useState(null),[K,U]=n.useState(!1),[q,P]=n.useState(!1),[$,V]=n.useState(null),Q=ue();n.useRef(null);const h=JSON.parse(localStorage.getItem("user")),f=h==null?void 0:h.role,j=h==null?void 0:h._id,[o,A]=n.useState({current:1,pageSize:10,total:0}),g=async(s={})=>{m(!0);try{const{current:t=o.current,pageSize:a=o.pageSize,searchText:r="",sortBy:c="createdAt",sortOrder:x="desc"}=s;let l=`${w}/paginated?page=${t}&pageSize=${a}&search=${r}&status=Customer`;c&&(l+=`&sortBy=${c}`),x&&(l+=`&sortOrder=${x}`),f==="Employee"&&j?l+=`&userId=${j}&role=${f}`:f==="Team Leader"&&j&&(l+=`&teamLeaderId=${j}&role=${f}`);const u=await y.get(l);M(u.data.data),A({...o,current:u.data.page,pageSize:u.data.pageSize,total:u.data.total})}catch(t){i.error("Failed to load customers"),console.error("Error fetching customers:",t)}finally{m(!1)}},X=async()=>{v(!0);try{const s=await y.get("/api/accounts/users");G(s.data)}catch(s){i.error("Failed to load user list"),console.error("Error fetching users:",s)}finally{v(!1)}};n.useEffect(()=>{g({current:o.current,pageSize:o.pageSize,searchText:d}),X()},[o.current,o.pageSize,d,f,j]);const Z=s=>{L(s),N(!0)},ee=async s=>{var t;m(!0);try{p!=null&&p._id?(await y.put(`${w}/${p._id}`,s),i.success("Customer updated successfully")):(await y.post(w,s),i.success("Customer created successfully")),g({current:o.current,pageSize:o.pageSize,searchText:d})}catch(a){i.error(`Failed to ${p!=null&&p._id?"update":"create"} customer`),console.error("Save customer error:",((t=a.response)==null?void 0:t.data)||a.message)}finally{N(!1),L(null),m(!1)}},te=(s,t)=>{R(t),B(s),I(!0)},se=async()=>{var s;m(!0);try{const t={...C,status:E};await y.put(`${w}/${C._id}`,t),i.success(`Status updated to ${E}`),g({current:o.current,pageSize:o.pageSize,searchText:d})}catch(t){i.error("Failed to update status"),console.error("Status update error:",((s=t.response)==null?void 0:s.data)||t.message)}finally{I(!1),R(null),B(null),m(!1)}},re=async s=>{var t;m(!0);try{await y.put(`${w}/${s}`,{status:"Closed",isCustomer:!1}),i.success("Customer status set to Closed"),g({current:o.current,pageSize:o.pageSize,searchText:d})}catch(a){i.error("Failed to close customer account"),console.error("Soft delete error:",((t=a.response)==null?void 0:t.data)||a.message)}finally{m(!1)}},oe=s=>{V(s),U(!0)},ae=s=>{V(s),P(!0)},ne=s=>{Q(`/customers/${s._id}`)},ie=async()=>{const s=document.getElementById("customerTable");if(!s){i.error("Table content not found for PDF export.");return}i.loading("Generating PDF...",{id:"pdf-toast"});try{const t=await je(s,{scale:2}),a=t.toDataURL("image/png"),r=new be("p","mm","a4"),c=210,x=297,l=t.height*c/t.width;let u=l,z=0;for(r.addImage(a,"PNG",0,z,c,l),u-=x;u>=0;)z=u-l,r.addPage(),r.addImage(a,"PNG",0,z,c,l),u-=x;r.save("Customers_Details.pdf"),i.success("PDF generated!",{id:"pdf-toast"})}catch(t){console.error("Error generating PDF:",t),i.error("Failed to generate PDF.",{id:"pdf-toast"})}},le=()=>{if(T.length===0){i.error("No data to export to Excel.");return}const s=T.map((r,c)=>{var l;return{"S.No":c+1+(o.current-1)*o.pageSize,"Business Name":r.businessName,"Contact Name":r.contactName,Email:r.email,"Mobile Number":r.mobileNumber,"Lead Type":r.type,Status:r.status,"Source Type":r.sourceType,"Assigned To":((l=r.assignedTo)==null?void 0:l.name)||"Unassigned","GST Number":r.gstNumber,"Phone Number":r.phoneNumber,"Address Line 1":r.addressLine1,"Address Line 2":r.addressLine2,"Address Line 3":r.addressLine3,Landmark:r.landmark,City:r.city,Pincode:r.pincode,State:r.state,Country:r.country,Website:r.website,"Is Customer":r.isCustomer?"Yes":"No","Created At":new Date(r.createdAt).toLocaleString()}}),t=F.json_to_sheet(s),a=F.book_new();F.book_append_sheet(a,t,"Customers Data"),Te(a,"Customers_Data.xlsx"),i.success("Data exported to Excel!")},ce=[{title:"Sno.",render:(s,t,a)=>a+1+(o.current-1)*o.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",render:(s,t)=>e.jsx("a",{onClick:()=>ne(t),style:{cursor:"pointer",color:"#0E2B43"},children:s}),sorter:!0},{title:"Contact Name",dataIndex:"contactName",sorter:!0},{title:"Email Id",dataIndex:"email",sorter:!0},{title:"Type",dataIndex:"type",render:s=>{switch(s){case"Hot":return e.jsx(b,{color:"red",children:"Hot"});case"Warm":return e.jsx(b,{color:"orange",children:"Warm"});case"Cold":return e.jsx(b,{color:"blue",children:"Cold"});default:return e.jsx(b,{children:"Unknown"})}},sorter:!0},{title:"Assigned To",dataIndex:["assignedTo","name"],render:(s,t)=>t.assignedTo?e.jsxs("span",{children:[t.assignedTo.name," (",t.assignedTo.role,")"]}):e.jsx("em",{children:"Unassigned"}),sorter:!0},{title:"Latest Note",render:(s,t)=>{var r;const a=(r=t.notes)==null?void 0:r[t.notes.length-1];return a?e.jsxs("div",{children:[e.jsx("small",{style:{color:"#888"},children:new Date(a.timestamp).toLocaleString()}),e.jsx("br",{}),a.text]}):e.jsx("em",{children:"No notes"})}},{title:"Status",dataIndex:"status",render:(s,t)=>e.jsx(b,{color:t.status==="Customer"?"blue":"gray",children:t.status}),sorter:!0},{title:"Actions",render:(s,t)=>e.jsx(ge,{overlay:e.jsxs(S,{children:[e.jsx(S.Item,{icon:e.jsx(_e,{}),onClick:()=>Z(t),children:"Edit Customer"},"edit"),e.jsx(S.Item,{icon:e.jsx(ke,{}),onClick:()=>oe(t),children:"View/Add Notes"},"notes"),e.jsx(S.Item,{icon:e.jsx(Ce,{}),onClick:()=>ae(t),children:"View/Add Follow-ups"},"followups"),e.jsx(S.Item,{onClick:()=>te("Active",t),children:"Change to Active Lead"},"change-to-active"),f==="Superadmin"&&e.jsx(S.Item,{children:e.jsxs(ve,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>re(t._id),okText:"Yes",cancelText:"No",children:[e.jsx(Le,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:e.jsx(D,{icon:e.jsx(we,{})})})}],de=(s,t,a)=>{A(s);const r=a.field,c=a.order==="ascend"?"asc":a.order==="descend"?"desc":void 0;g({current:s.current,pageSize:s.pageSize,searchText:d,sortBy:r,sortOrder:c})};return e.jsxs("div",{children:[e.jsxs(Ne,{children:[e.jsxs(Ie,{gutter:[16,16],align:"middle",style:{marginBottom:16},children:[e.jsx(_,{xs:24,sm:12,md:8,lg:6,children:e.jsx(Be,{level:4,style:{margin:0},children:"Customers"})}),e.jsx(_,{xs:24,sm:12,md:8,lg:6,children:e.jsx($e,{placeholder:"Search by Business Name, Contact Name or Email",prefix:e.jsx(Ae,{}),value:d,onChange:s=>{O(s.target.value),A({...o,current:1})},style:{width:"100%"}})}),e.jsx(_,{xs:24,sm:24,md:8,lg:12,style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(me,{wrap:!0,children:[e.jsx(D,{icon:e.jsx(he,{}),onClick:ie,style:{backgroundColor:"#0E2B43",borderColor:"#0E2B43",color:"white"},className:"orange-button",children:"Export to PDF"}),e.jsx(D,{icon:e.jsx(fe,{}),onClick:le,style:{backgroundColor:"#0E2B43",borderColor:"#0E2B43",color:"white"},className:"orange-button",children:"Export to Excel"})]})})]}),k?e.jsx(pe,{size:"large",style:{display:"block",margin:"50px auto"}}):T.length>0?e.jsx("div",{id:"customerTable",children:e.jsx(ze,{columns:ce,dataSource:T,rowKey:"_id",pagination:o,onChange:de,scroll:{x:"max-content"},className:"customers-table"})}):e.jsx(De,{description:"No customers found."})]}),e.jsx(xe,{visible:Y,onClose:()=>N(!1),onSave:ee,initialValues:p,allUsers:H,loadingUsers:W}),e.jsx(Fe,{title:"Confirm Status Change",open:J,onOk:se,onCancel:()=>I(!1),okText:"Yes",cancelText:"No",confirmLoading:k,children:e.jsxs("p",{children:["Are you sure you want to change the status of ",e.jsx("strong",{children:C==null?void 0:C.businessName})," to ",e.jsx("strong",{children:E}),"?"]})}),$&&e.jsxs(e.Fragment,{children:[e.jsx(Se,{visible:q,onClose:()=>P(!1),account:$,refreshAccounts:()=>g({current:o.current,pageSize:o.pageSize,searchText:d})}),e.jsx(ye,{visible:K,onClose:()=>U(!1),account:$,refreshAccounts:()=>g({current:o.current,pageSize:o.pageSize,searchText:d})})]})]})};export{It as default};
