import{s as D,B as y,q as e}from"./index-Db3Ct3vh.js";import{F as t,r as x,D as $,K as G,m as w,n as d,c as i,l as I,T as M,B,q as Y,Q as W,z as q,o as Q,L as O,A as z}from"./antd-CjRtIVzR.js";import{Q as J,e as K,u as H}from"./icons-De3RWgvB.js";import{h as R}from"./moment-C5S46NFB.js";const{TextArea:X}=i,{Option:o}=I,{Title:k}=M,oe=({visible:j,onClose:F,initialValues:l,allUsers:A=[],loadingUsers:f=!1})=>{const[c]=t.useForm(),[b,u]=x.useState(!1),[S,C]=x.useState([]),[N,T]=x.useState(!1),[a,m]=x.useState([]);x.useEffect(()=>{j&&(T(!0),D.get("/api/service").then(s=>C(s.data)).catch(()=>y.error("Failed to load services")).finally(()=>T(!1)))},[j]),x.useEffect(()=>{var s,r;if(!l){c.resetFields(),c.setFieldsValue({sourceType:"Direct",status:"Active",billingCycle:"Monthly",totalPrice:0,country:"INDIA"});return}if(c.setFieldsValue({...l,selectedService:(s=l.selectedService)==null?void 0:s._id,selectedPlan:l.selectedPlan||null,assignedTo:((r=l.assignedTo)==null?void 0:r._id)||null}),l.selectedService){const n=l.selectedService;m(n.plans||[])}},[l]);const g=()=>{const s=c.getFieldValue("selectedService"),r=c.getFieldValue("selectedPlan"),n=c.getFieldValue("billingCycle");if(!s||!r||!n)return;const v=S.find(L=>L._id===s),h=v==null?void 0:v.plans.find(L=>L._id===r);if(!h)return;let p=0;n==="Monthly"?p=h.priceMonthly:n==="Yearly"?p=h.priceYearly:n==="One Time"&&(p=h.priceOneTime);const E=p*(v.gstRate||0)/100;c.setFieldValue("totalPrice",Math.round(p+E))},P=s=>{const r=S.find(n=>n._id===s);c.setFieldsValue({selectedPlan:null,billingCycle:"Monthly",totalPrice:0}),m((r==null?void 0:r.plans)||[])},_=async()=>{var s,r;try{const n=await c.validateFields();u(!0);const v=l!=null&&l._id?"put":"post",h=l!=null&&l._id?`/api/accounts/${l._id}`:"/api/accounts";await D[v](h,n),y.success(l!=null&&l._id?"Account updated!":"Account created!"),F()}catch(n){y.error(((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.message)||"Failed to save")}finally{u(!1)}};return e.jsx($,{title:l?"Edit Business Account":"Create Business Account",width:900,onClose:F,open:j,styles:{body:{paddingBottom:80}},footer:e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx(B,{onClick:F,children:"Cancel"}),e.jsx(B,{type:"primary",loading:b,onClick:_,style:{backgroundColor:"#0E2B43",borderColor:"orange"},children:l?"Update":"Create"})]}),children:e.jsx(G,{spinning:f||N,children:e.jsxs(t,{form:c,layout:"vertical",children:[e.jsxs(w,{gutter:16,children:[e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"businessName",label:"Business Name",rules:[{required:!0}],children:e.jsx(i,{placeholder:"Enter Business Name"})})}),e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"gstNumber",label:"GST Number",children:e.jsx(i,{placeholder:"Enter GST Number"})})})]}),e.jsxs(w,{gutter:16,children:[e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"contactName",label:"Primary Contact Name",rules:[{required:!0}],children:e.jsx(i,{placeholder:"Enter Primary Contact"})})}),e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"contactEmail",label:"Email",children:e.jsx(i,{placeholder:"Enter Email"})})})]}),e.jsxs(w,{gutter:16,children:[e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"contactNumber",label:"Mobile Number",rules:[{required:!0}],children:e.jsx(i,{placeholder:"+91 9876543210"})})}),e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"typeOfLead",label:"Type of Leads",rules:[{required:!0}],children:e.jsxs(I,{mode:"multiple",placeholder:"Select Lead Type",children:[e.jsx(o,{value:"Fixed client",children:"Fixed client"}),e.jsx(o,{value:"Revenue based client",children:"Revenue based client"}),e.jsx(o,{value:"Vrism Product",children:"Vrism Product"}),e.jsx(o,{value:"others",children:"Others"})]})})})]}),e.jsx("div",{style:{marginBottom:16},children:e.jsx(k,{level:5,children:"Additional Contact Persons"})}),e.jsx(t.List,{name:"additionalContactPersons",children:(s,{add:r,remove:n})=>e.jsxs(e.Fragment,{children:[s.map(({key:v,name:h,...p})=>e.jsxs("div",{style:{border:"1px solid #d9d9d9",padding:16,marginBottom:16,borderRadius:8},children:[e.jsxs(w,{gutter:16,children:[e.jsx(d,{span:11,children:e.jsx(t.Item,{...p,name:[h,"name"],label:"Name",children:e.jsx(i,{})})}),e.jsx(d,{span:11,children:e.jsx(t.Item,{...p,name:[h,"email"],label:"Email",children:e.jsx(i,{})})}),e.jsx(d,{span:2,children:e.jsx(J,{onClick:()=>n(h)})})]}),e.jsx(w,{gutter:16,children:e.jsx(d,{span:11,children:e.jsx(t.Item,{...p,name:[h,"phoneNumber"],label:"Phone",children:e.jsx(i,{})})})})]},v)),e.jsx(t.Item,{children:e.jsx(B,{type:"dashed",block:!0,onClick:r,icon:e.jsx(Y,{}),children:"Add Additional Contact"})})]})}),e.jsx(k,{level:5,children:"Address"}),e.jsxs(w,{gutter:16,children:[e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"addressLine1",label:"Address Line 1",children:e.jsx(i,{placeholder:"Line 1"})})}),e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"addressLine2",label:"Address Line 2",children:e.jsx(i,{placeholder:"Line 2"})})})]}),e.jsxs(w,{gutter:16,children:[e.jsx(d,{span:8,children:e.jsx(t.Item,{name:"city",label:"City",children:e.jsx(i,{placeholder:"City"})})}),e.jsx(d,{span:8,children:e.jsx(t.Item,{name:"state",label:"State",children:e.jsx(i,{placeholder:"State"})})}),e.jsx(d,{span:8,children:e.jsx(t.Item,{name:"pincode",label:"Pincode",children:e.jsx(i,{placeholder:"Pincode"})})})]}),e.jsxs(w,{gutter:16,children:[e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"country",label:"Country",children:e.jsx(i,{placeholder:"Country"})})}),e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"website",label:"Website URL",children:e.jsx(i,{placeholder:"www.example.com"})})})]}),e.jsxs(w,{gutter:16,children:[e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"status",label:"Account Status",rules:[{required:!0}],children:e.jsxs(I,{children:[e.jsx(o,{value:"Active",children:"Active"}),e.jsx(o,{value:"Pipeline",children:"Pipeline"}),e.jsx(o,{value:"Quotations",children:"Quotations"}),e.jsx(o,{value:"Customer",children:"Customer"}),e.jsx(o,{value:"Closed",children:"Closed"}),e.jsx(o,{value:"TargetLeads",children:"Target Leads"})]})})}),e.jsx(d,{span:12,children:e.jsx(t.Item,{name:"sourceType",label:"Source Type",children:e.jsxs(I,{children:[e.jsx(o,{value:"Direct",children:"Direct"}),e.jsx(o,{value:"Referral",children:"Referral"}),e.jsx(o,{value:"Website",children:"Website"}),e.jsx(o,{value:"Social Media",children:"Social Media"}),e.jsx(o,{value:"others",children:"Others"})]})})})]}),e.jsx(t.Item,{name:"assignedTo",label:"Assigned To",children:e.jsx(I,{allowClear:!0,showSearch:!0,children:A.map(s=>e.jsxs(o,{value:s._id,children:[s.name," (",s.role,")"]},s._id))})}),e.jsx(k,{level:5,children:"Service & Pricing"}),e.jsx(t.Item,{name:"selectedService",label:"Select Service",children:e.jsx(I,{placeholder:"Choose service",loading:N,onChange:P,children:S.map(s=>e.jsx(o,{value:s._id,children:s.serviceName},s._id))})}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(t.Item,{name:"selectedPlan",label:"Select Plan",children:e.jsx(I,{onChange:g,children:a.map(s=>e.jsx(o,{value:s._id,children:s.name},s._id))})}),e.jsx(t.Item,{name:"billingCycle",label:"Billing Cycle",children:e.jsxs(I,{onChange:g,children:[e.jsx(o,{value:"Monthly",children:"Monthly"}),e.jsx(o,{value:"One Time",children:"One Time"}),e.jsx(o,{value:"Yearly",children:"Yearly"})]})}),e.jsx(t.Item,{name:"totalPrice",label:"Total Price (With GST)",children:e.jsx(W,{readOnly:!0,style:{width:"100%"}})})]}),e.jsx(t.Item,{name:"notes",label:"Add Note",children:e.jsx(X,{rows:3,placeholder:"Add any notes related to this account"})})]})})})},{TextArea:Z}=i,{Title:V,Text:ee}=M,ae=({visible:j,onClose:F,account:l,refreshAccounts:A})=>{const[f]=t.useForm(),[c,b]=x.useState(!1),[u,S]=x.useState([]);x.useEffect(()=>{j&&(l!=null&&l._id)&&S(l.notes||[])},[j,l]);const C=()=>{try{const a=JSON.parse(localStorage.getItem("user"));return(a==null?void 0:a.email)||"Unknown"}catch{return"Unknown"}},N=async()=>{try{const{note:a}=await f.validateFields();b(!0);const m={text:a,timestamp:new Date().toLocaleString(),author:C()},g=[...u,m];await D.put(`/api/accounts/${l._id}`,{...l,notes:g}),y.success("Note added successfully!"),S(g),f.resetFields(),A()}catch{y.error("Failed to add note.")}finally{b(!1)}},T=()=>!u||u.length===0?e.jsx(ee,{type:"secondary",children:"No notes to show"}):u.map((a,m)=>{const g=m>0?u[m-1]:null,P=new Date(a.timestamp).toDateString(),_=g?new Date(g.timestamp).toDateString():null,s=P!==_;return e.jsxs("div",{children:[s&&e.jsx("div",{className:"note-date-header",children:P}),e.jsxs("div",{className:"note-bubble",children:[e.jsxs("div",{className:"note-meta",children:[a.author,"    ",a.timestamp]}),e.jsx("div",{className:"note-text",children:a.text})]})]},m)});return e.jsxs($,{title:e.jsxs(V,{level:4,style:{margin:0},children:["Notes for ",l.businessName]}),open:j,onClose:F,width:440,bodyStyle:{padding:"24px"},destroyOnClose:!0,children:[T(),e.jsx(q,{}),e.jsxs(t,{form:f,layout:"vertical",children:[e.jsx(t.Item,{name:"note",label:"Add Note",rules:[{required:!0,message:"Please enter a note"}],children:e.jsx(Z,{rows:3,placeholder:"Type your note here...",disabled:c})}),e.jsx(B,{type:"primary",style:{backgroundColor:"#0E2B43",borderColor:"#orange",color:"white"},icon:e.jsx(Y,{}),onClick:N,loading:c,block:!0,children:"Add Note"})]})]})},{TextArea:se}=i,{Text:U}=M,de=({visible:j,onClose:F,account:l,refreshAccounts:A})=>{const[f,c]=x.useState(""),[b,u]=x.useState(null),[S,C]=x.useState(!1),[N,T]=x.useState([]),[a,m]=x.useState(null);x.useEffect(()=>{j&&(l!=null&&l._id)?g():(T([]),m(null),c(""),u(null))},[j,l]);const g=async()=>{if(l!=null&&l._id){C(!0);try{const s=await D.get(`/api/accounts/${l._id}/followups`);T(s.data.sort((r,n)=>R(n.createdAt).diff(R(r.createdAt)))||[])}catch(s){console.error("Error fetching follow-ups:",s),y.error("Failed to fetch follow-ups")}finally{C(!1)}}},P=()=>{if(!f.trim()||!b){y.error("Please select a date and enter a note for the follow-up.");return}const s=JSON.parse(localStorage.getItem("user")),r=s==null?void 0:s._id;if(!r){y.error("User information not found. Please log in.");return}C(!0);const n={date:b.toISOString(),note:f.trim(),addedBy:r};(a===null?D.post(`/api/accounts/${l._id}/followups`,n):D.put(`/api/accounts/${l._id}/followups/${a._id}`,n)).then(()=>{y.success(a===null?"Follow-up added successfully!":"Follow-up updated successfully!"),c(""),u(null),m(null),g(),typeof A=="function"&&A()}).catch(h=>{var p,E;console.error("Error saving follow-up:",h),y.error(((E=(p=h==null?void 0:h.response)==null?void 0:p.data)==null?void 0:E.message)||"Failed to save follow-up.")}).finally(()=>C(!1))},_=s=>{var r,n;return e.jsx(O.Item,{children:e.jsxs("div",{style:{backgroundColor:"#f0f2f5",borderRadius:"12px",padding:"10px 15px",maxWidth:"calc(100% - 80px)",flexGrow:1},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:"5px"},children:[e.jsx(K,{style:{marginRight:"5px",color:"#888"}}),e.jsx(U,{strong:!0,style:{marginRight:"10px",color:"#333"},children:((r=s.addedBy)==null?void 0:r.name)||((n=s.addedBy)==null?void 0:n.email)||"Unknown User"}),e.jsx(z,{style:{marginRight:"5px",color:"#888"}}),e.jsxs(U,{type:"secondary",style:{fontSize:"0.8em"},children:[R(s.createdAt).format("DD/MM/YYYY, h:mm:ss A")," "]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"flex-start"},children:[e.jsx(H,{style:{marginRight:"8px",marginTop:"3px",color:"#555"}}),e.jsx(U,{style:{flexGrow:1},children:s.note})]})]})})};return e.jsxs($,{title:`Follow-ups for Account: ${(l==null?void 0:l.businessName)||"N/A"}`,open:j,onClose:()=>{m(null),c(""),u(null),F()},width:720,children:[e.jsxs("div",{style:{marginBottom:20},children:[e.jsx(Q,{style:{width:"100%",marginBottom:8},format:"DD-MM-YYYY",value:b,onChange:s=>u(s),placeholder:"Select follow-up date"}),e.jsx(se,{rows:4,placeholder:"Enter follow-up note",value:f,onChange:s=>c(s.target.value)}),e.jsx(B,{type:"primary",style:{marginTop:10,backgroundColor:"#0E2B43",borderColor:"#0E2B43",color:"white"},block:!0,onClick:P,loading:S,children:a===null?"Add Follow-up":"Update Follow-up"})]}),e.jsxs(q,{children:["All Follow-ups (",N.length,")"]}),e.jsx(O,{dataSource:N,renderItem:_,locale:{emptyText:"No follow-ups found for this account."},style:{marginTop:16}})]})};export{oe as B,de as F,ae as N};
