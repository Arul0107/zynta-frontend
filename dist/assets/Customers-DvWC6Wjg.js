import{u as de,q as e,s as S,B as l,D,G as ue}from"./index-Db3Ct3vh.js";import{r as n,C as pe,m as ge,n as z,T as me,c as he,h as xe,S as fe,B as F,K as Se,b as ye,E as Ce,M as je,e as be,Z as we,U as y,y as Ne,P as Te,a as Ie,v as Ee}from"./antd-CjRtIVzR.js";import{B as $e,F as Ae,N as De}from"./FollowUpDrawer-Do9LnWUu.js";import{h as ze,E as Fe}from"./html2canvas.esm-DBTO1nPv.js";import{a as _e,c as ve,T as ke,u as Le,W as Be}from"./icons-De3RWgvB.js";import"./react-DoC2WAmd.js";import"./moment-C5S46NFB.js";const{Title:Pe}=me,{TabPane:Ye}=Ee,b="/api/accounts",He=()=>{const[d,V]=n.useState(""),[w,O]=n.useState([]),[_,p]=n.useState(!1),[M,G]=n.useState([]),[W,v]=n.useState(!1),[Y,N]=n.useState(!1),[g,k]=n.useState(null),[H,T]=n.useState(!1),[C,L]=n.useState(null),[I,B]=n.useState(null),[K,P]=n.useState(!1),[q,U]=n.useState(!1),[E,R]=n.useState(null),J=de();n.useRef(null);const h=JSON.parse(localStorage.getItem("user")),x=h==null?void 0:h.role,j=h==null?void 0:h._id,[o,$]=n.useState({current:1,pageSize:10,total:0}),m=async(s={})=>{p(!0);try{const{current:t=o.current,pageSize:r=o.pageSize,searchText:a="",sortBy:i="createdAt",sortOrder:f="desc"}=s;let c=`${b}/paginated?page=${t}&pageSize=${r}&search=${a}&status=Customer`;i&&(c+=`&sortBy=${i}`),f&&(c+=`&sortOrder=${f}`),x==="Employee"&&j?c+=`&userId=${j}&role=${x}`:x==="Team Leader"&&j&&(c+=`&teamLeaderId=${j}&role=${x}`);const u=await S.get(c);O(u.data.data),$({...o,current:u.data.page,pageSize:u.data.pageSize,total:u.data.total})}catch(t){l.error("Failed to load customers"),console.error("Error fetching customers:",t)}finally{p(!1)}},Z=async()=>{v(!0);try{const s=await S.get("/api/accounts/users");G(s.data)}catch(s){l.error("Failed to load user list"),console.error("Error fetching users:",s)}finally{v(!1)}};n.useEffect(()=>{m({current:o.current,pageSize:o.pageSize,searchText:d}),Z()},[o.current,o.pageSize,d,x,j]);const Q=s=>{k(s),N(!0)},X=async s=>{var t;p(!0);try{g!=null&&g._id?(await S.put(`${b}/${g._id}`,s),l.success("Customer updated successfully")):(await S.post(b,s),l.success("Customer created successfully")),m({current:o.current,pageSize:o.pageSize,searchText:d})}catch(r){l.error(`Failed to ${g!=null&&g._id?"update":"create"} customer`),console.error("Save customer error:",((t=r.response)==null?void 0:t.data)||r.message)}finally{N(!1),k(null),p(!1)}},ee=(s,t)=>{L(t),B(s),T(!0)},te=async()=>{var s;p(!0);try{const t={...C,status:I};await S.put(`${b}/${C._id}`,t),l.success(`Status updated to ${I}`),m({current:o.current,pageSize:o.pageSize,searchText:d})}catch(t){l.error("Failed to update status"),console.error("Status update error:",((s=t.response)==null?void 0:s.data)||t.message)}finally{T(!1),L(null),B(null),p(!1)}},se=async s=>{var t;p(!0);try{await S.put(`${b}/${s}`,{status:"Closed",isCustomer:!1}),l.success("Customer status set to Closed"),m({current:o.current,pageSize:o.pageSize,searchText:d})}catch(r){l.error("Failed to close customer account"),console.error("Soft delete error:",((t=r.response)==null?void 0:t.data)||r.message)}finally{p(!1)}},ae=s=>{R(s),P(!0)},oe=s=>{R(s),U(!0)},re=s=>{J(`/customers/${s._id}`)},ne=async()=>{const s=document.getElementById("customerTable");if(!s){l.error("Table content not found for PDF export.");return}l.loading("Generating PDF...",{id:"pdf-toast"});try{const t=await ze(s,{scale:2}),r=t.toDataURL("image/png"),a=new Fe("p","mm","a4"),i=210,f=297,c=t.height*i/t.width;let u=c,A=0;for(a.addImage(r,"PNG",0,A,i,c),u-=f;u>=0;)A=u-c,a.addPage(),a.addImage(r,"PNG",0,A,i,c),u-=f;a.save("Customers_Details.pdf"),l.success("PDF generated!",{id:"pdf-toast"})}catch(t){console.error("Error generating PDF:",t),l.error("Failed to generate PDF.",{id:"pdf-toast"})}},le=()=>{if(w.length===0){l.error("No data to export to Excel.");return}const s=w.map((a,i)=>{var c;return{"S.No":i+1+(o.current-1)*o.pageSize,"Business Name":a.businessName,"Contact Name":a.contactName,Email:a.email,"Mobile Number":a.mobileNumber,"Lead Type":a.type,Status:a.status,"Source Type":a.sourceType,"Assigned To":((c=a.assignedTo)==null?void 0:c.name)||"Unassigned","GST Number":a.gstNumber,"Phone Number":a.phoneNumber,"Address Line 1":a.addressLine1,"Address Line 2":a.addressLine2,"Address Line 3":a.addressLine3,Landmark:a.landmark,City:a.city,Pincode:a.pincode,State:a.state,Country:a.country,Website:a.website,"Is Customer":a.isCustomer?"Yes":"No","Created At":new Date(a.createdAt).toLocaleString()}}),t=D.json_to_sheet(s),r=D.book_new();D.book_append_sheet(r,t,"Customers Data"),ue(r,"Customers_Data.xlsx"),l.success("Data exported to Excel!")},ce=[{title:"Sno.",render:(s,t,r)=>r+1+(o.current-1)*o.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",render:(s,t)=>e.jsx("a",{onClick:()=>re(t),style:{cursor:"pointer",color:"#0E2B43"},children:s}),sorter:!0},{title:"Contact Name",dataIndex:"contactName",sorter:!0},{title:"Email Id",dataIndex:"contactEmail",sorter:!0},{title:"Assigned To",dataIndex:["assignedTo","name"],render:(s,t)=>t.assignedTo?e.jsxs("span",{children:[t.assignedTo.name," (",t.assignedTo.role,")"]}):e.jsx("em",{children:"Unassigned"}),sorter:!0},{title:"Latest Note",render:(s,t)=>{var a;const r=(a=t.notes)==null?void 0:a[t.notes.length-1];return r?e.jsxs("div",{children:[e.jsx("small",{style:{color:"#888"},children:new Date(r.timestamp).toLocaleString()}),e.jsx("br",{}),r.text]}):e.jsx("em",{children:"No notes"})}},{title:"Status",dataIndex:"status",render:(s,t)=>e.jsx(be,{color:t.status==="Customer"?"blue":"gray",children:t.status}),sorter:!0},{title:"Actions",render:(s,t)=>e.jsx(we,{overlay:e.jsxs(y,{children:[e.jsx(y.Item,{icon:e.jsx(Ne,{}),onClick:()=>Q(t),children:"Edit Customer"},"edit"),e.jsx(y.Item,{icon:e.jsx(Le,{}),onClick:()=>ae(t),children:"View/Add Notes"},"notes"),e.jsx(y.Item,{icon:e.jsx(Be,{}),onClick:()=>oe(t),children:"View/Add Follow-ups"},"followups"),e.jsx(y.Item,{onClick:()=>ee("Active",t),children:"Change to Active Lead"},"change-to-active"),x==="Superadmin"&&e.jsx(y.Item,{children:e.jsxs(Te,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>se(t._id),okText:"Yes",cancelText:"No",children:[e.jsx(Ie,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:e.jsx(F,{icon:e.jsx(ke,{})})})}],ie=(s,t,r)=>{$(s);const a=r.field,i=r.order==="ascend"?"asc":r.order==="descend"?"desc":void 0;m({current:s.current,pageSize:s.pageSize,searchText:d,sortBy:a,sortOrder:i})};return e.jsxs("div",{children:[e.jsxs(pe,{children:[e.jsxs(ge,{gutter:[16,16],align:"middle",style:{marginBottom:16},children:[e.jsx(z,{xs:24,sm:12,md:8,lg:6,children:e.jsx(Pe,{level:4,style:{margin:0},children:"Customers"})}),e.jsx(z,{xs:24,sm:12,md:8,lg:6,children:e.jsx(he,{placeholder:"Search by Business Name, Contact Name or Email",prefix:e.jsx(xe,{}),value:d,onChange:s=>{V(s.target.value),$({...o,current:1})},style:{width:"100%"}})}),e.jsx(z,{xs:24,sm:24,md:8,lg:12,style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(fe,{wrap:!0,children:[e.jsx(F,{icon:e.jsx(_e,{}),onClick:ne,style:{backgroundColor:"#0E2B43",borderColor:"#0E2B43",color:"white"},className:"orange-button",children:"Export to PDF"}),e.jsx(F,{icon:e.jsx(ve,{}),onClick:le,style:{backgroundColor:"#0E2B43",borderColor:"#0E2B43",color:"white"},className:"orange-button",children:"Export to Excel"})]})})]}),_?e.jsx(Se,{size:"large",style:{display:"block",margin:"50px auto"}}):w.length>0?e.jsx("div",{id:"customerTable",children:e.jsx(ye,{columns:ce,dataSource:w,rowKey:"_id",pagination:o,onChange:ie,scroll:{x:"max-content"},className:"customers-table"})}):e.jsx(Ce,{description:"No customers found."})]}),e.jsx($e,{visible:Y,onClose:()=>N(!1),onSave:X,initialValues:g,allUsers:M,loadingUsers:W}),e.jsx(je,{title:"Confirm Status Change",open:H,onOk:te,onCancel:()=>T(!1),okText:"Yes",cancelText:"No",confirmLoading:_,children:e.jsxs("p",{children:["Are you sure you want to change the status of ",e.jsx("strong",{children:C==null?void 0:C.businessName})," to ",e.jsx("strong",{children:I}),"?"]})}),E&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{visible:q,onClose:()=>U(!1),account:E,refreshAccounts:()=>m({current:o.current,pageSize:o.pageSize,searchText:d})}),e.jsx(De,{visible:K,onClose:()=>P(!1),account:E,refreshAccounts:()=>m({current:o.current,pageSize:o.pageSize,searchText:d})})]})]})};export{He as default};
