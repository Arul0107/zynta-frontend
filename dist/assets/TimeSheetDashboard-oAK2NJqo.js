import{r as d,x as t,O as re,y as Y,B as x,V as u}from"./index-Dx0fORvq.js";import{i as I}from"./axios-By3bUnR1.js";import{d as m,D as z}from"./index-gtlyNNxV.js";import{F as S}from"./index-BHKMv-_S.js";import{R as ie}from"./row-D7mQAf0A.js";import{T as ne}from"./index-DkVdE_3I.js";import{F as le}from"./Table-BFHR8fXI.js";import{M as P}from"./index-Cdvz5H4l.js";import{I as de}from"./index-CycGH6gG.js";import{S as E}from"./index-Bcd2XmZI.js";import{P as ce}from"./index-D4CZw55Y.js";import"./TextArea-Bqwst6Wg.js";import"./ExclamationCircleFilled-ctPYYyzk.js";import"./EditOutlined--TcujLaX.js";import"./styleChecker-BIxzM-w-.js";import"./addEventListener-CZDGFXVg.js";import"./index-Bq5jwgzS.js";import"./Pagination-9G_nljkd.js";import"./extendsObject-78o_rR5W.js";import"./InfoCircleFilled-CGhkVSDg.js";import"./ActionButton-DcYFGn3W.js";import"./index-o4REvhBZ.js";import"./useClosable-D6ihuouj.js";import"./context-LTZAWJIx.js";const{Title:me}=ne,{TextArea:ue}=de,{Option:$}=E,{RangePicker:pe}=z;function He(){var L,W;const[M,k]=d.useState([]),[v,y]=d.useState(!1),[B,b]=d.useState(!1),[F,U]=d.useState(null),[O]=S.useForm(),[A,T]=d.useState({}),[j,_]=d.useState({}),[R,q]=d.useState([]),[N,G]=d.useState([]),[J,D]=d.useState(!1),[c,K]=d.useState(null),[g,C]=d.useState([]),p=JSON.parse(localStorage.getItem("user"))||{_id:"temp_id_123",name:"Guest User",role:"Employee",email:"guest@example.com"},w=["Admin","Superadmin"].includes(p.role),Q=async()=>{try{const[e,s]=await Promise.all([I.get("/api/accounts"),I.get("/api/service")]);q(e.data||[]),G(s.data||[])}catch{u.error("Failed to fetch accounts or services")}},X=e=>{const s=Math.floor(Math.abs(e)/3600),a=Math.floor(Math.abs(e)%3600/60),o=Math.floor(Math.abs(e)%60);return`${e<0?"+":""}${s.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},V=e=>{if(!e)return"";const s=Math.floor(e*3600),a=Math.floor(s/3600),o=Math.floor(s%3600/60),r=s%60;return`${a}h ${o}m ${r}s`},H=async()=>{try{y(!0);let e,s;g&&g.length===2?(e=g[0].startOf("day").toISOString(),s=g[1].endOf("day").toISOString()):(e=m().startOf("day").toISOString(),s=m().endOf("day").toISOString());const a={start:e,end:s};w||(a.userId=p._id);const r=(await I.get("/api/work-sessions/range",{params:a})).data.history||[],n=[];r.forEach(i=>{i.sessions.forEach(f=>{(w||f.userId===p._id)&&n.push({...f,key:f._id,dateLabel:i.date,loginTimeFormatted:m(f.loginTime).format("hh:mm:ss A"),logoutTimeFormatted:f.logoutTime?m(f.logoutTime).format("hh:mm:ss A"):""})})}),k(n);const l={},h={};n.forEach(i=>{const f=i.totalHours?Math.floor(i.totalHours*3600):0;l[i.key]=i.logoutTime?f:Math.floor(8*3600-(Date.now()-new Date(i.loginTime).getTime())/1e3),h[i.key]=!i.logoutTime}),T(l),_(h)}catch(e){console.error(e),u.error("Failed to fetch sessions")}finally{y(!1)}};d.useEffect(()=>{Q(),C([m().startOf("day"),m().endOf("day")])},[]),d.useEffect(()=>{g.length===2&&H()},[g]),d.useEffect(()=>{const e=setInterval(()=>{T(s=>{const a={};return Object.keys(s).forEach(o=>{a[o]=j[o]?s[o]-1:s[o]}),a})},1e3);return()=>clearInterval(e)},[j]);const Z=async()=>{var s,a;if(Object.values(j).some(o=>o)){u.error("A work session is already running.");return}y(!0);try{const r=(await I.post("/api/work-sessions/start",{userId:p._id,name:p.name,email:p.email})).data.session,n={key:r._id,...r,loginTimeFormatted:m(r.loginTime).format("hh:mm:ss A"),logoutTimeFormatted:"",dateLabel:m(r.loginTime).format("DD-MM-YYYY")};k(l=>[n,...l]),T(l=>({...l,[r._id]:Math.floor(8*3600-(Date.now()-new Date(r.loginTime).getTime())/1e3)})),_(l=>({...l,[r._id]:!0})),u.success("Work started successfully!")}catch(o){u.error(((a=(s=o.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to start work")}finally{y(!1)}},ee=async e=>{var s,a;y(!0);try{const r=(await I.post("/api/work-sessions/stop",{sessionId:e})).data.session;k(n=>n.map(l=>l.key===e?{...l,logoutTimeFormatted:m(r.logoutTime).format("hh:mm:ss A"),totalHours:r.totalHours}:l)),_(n=>({...n,[e]:!1})),T(n=>({...n,[e]:Math.floor(r.totalHours*3600)})),u.success("Work stopped successfully!")}catch(o){u.error(((a=(s=o.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to stop work")}finally{y(!1)}},te=async e=>{var s,a,o,r;try{await I.post("/api/work-sessions/eod",{sessionId:F.key,eod:e.eod,accountIds:e.accountIds,serviceIds:e.serviceIds,date:e.date?e.date.toISOString():null});const n=(a=(s=e.accountIds)==null?void 0:s.map(h=>R.find(i=>i._id===h)))==null?void 0:a.filter(Boolean),l=(r=(o=e.serviceIds)==null?void 0:o.map(h=>N.find(i=>i._id===h)))==null?void 0:r.filter(Boolean);k(h=>h.map(i=>i.key===F.key?{...i,eod:e.eod,accountIds:n,serviceIds:l,date:e.date?e.date.toISOString():i.date}:i)),b(!1),O.resetFields(),u.success("EOD saved!")}catch{u.error("Failed to save EOD")}},se=e=>{K(e),D(!0)},oe=[{title:"Date",dataIndex:"dateLabel",responsive:["md"]},{title:"Name",dataIndex:"name",responsive:["lg"]},{title:"Login",dataIndex:"loginTimeFormatted"},{title:"Logout",dataIndex:"logoutTimeFormatted"},{title:"Timer",render:(e,s)=>t.jsx("span",{className:j[s.key]?"countdown":A[s.key]>8*3600?"overtime":"",children:X(A[s.key]||0)})},{title:"Worked Hours",dataIndex:"totalHours",render:(e,s)=>V(s.totalHours),responsive:["md"]},{title:"Accounts",render:(e,s)=>{var a;return((a=s.accountIds)==null?void 0:a.map(o=>o.businessName).join(", "))||"-"},responsive:["lg"]},{title:"Services",render:(e,s)=>{var a;return((a=s.serviceIds)==null?void 0:a.map(o=>o.serviceName||o.name).join(", "))||"-"},responsive:["lg"]},{title:"EOD",render:(e,s)=>t.jsxs(Y,{size:"small",children:[t.jsx(x,{type:"link",size:"small",onClick:()=>{var a,o;U(s),b(!0),O.setFieldsValue({eod:s.eod||"",accountIds:((a=s.accountIds)==null?void 0:a.map(r=>r._id))||[],serviceIds:((o=s.serviceIds)==null?void 0:o.map(r=>r._id))||[],date:s.date?m(s.date):null})},children:s.eod?"Edit":"Add"}),s.eod&&t.jsx(x,{type:"link",size:"small",onClick:()=>se(s),children:"View"})]})},{title:"Actions",render:(e,s)=>{const a=j[s.key],o=s.userId===p._id;return a&&(w||o)?t.jsx(ce,{title:"Are you sure you want to stop work?",onConfirm:()=>ee(s.key),okText:"Yes",cancelText:"No",children:t.jsx(x,{type:"danger",size:"small",children:"Stop"})}):null}}],ae=M.some(e=>e.userId===p._id&&j[e.key]);return t.jsxs("div",{className:"timesheet-dashboard-container",children:[t.jsx(re,{position:"top-right",reverseOrder:!1}),t.jsxs(ie,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[t.jsx(me,{level:2,children:"Timesheet Dashboard"}),t.jsxs(Y,{wrap:!0,size:"middle",children:[t.jsx(pe,{onChange:C,value:g,style:{width:"100%"}}),t.jsx(x,{type:"primary",onClick:H,loading:v,children:"Fetch History"}),!w&&!ae&&t.jsx(x,{type:"primary",loading:v,onClick:Z,children:"Start Work"})]})]}),t.jsx(le,{columns:oe,dataSource:M,pagination:!1,rowKey:"key",loading:v,scroll:{x:"max-content"}}),t.jsx(P,{title:"End of Day Notes",open:B,onCancel:()=>b(!1),footer:null,children:t.jsxs(S,{form:O,layout:"vertical",onFinish:te,children:[t.jsx(S.Item,{label:"EOD Message",name:"eod",rules:[{required:!0,message:"Please enter your EOD message"}],children:t.jsx(ue,{rows:4})}),t.jsx(S.Item,{label:"Select Accounts",name:"accountIds",rules:[{type:"array",message:"Please select at least one account"}],children:t.jsx(E,{mode:"multiple",placeholder:"Select accounts",children:R.map(e=>t.jsx($,{value:e._id,children:e.businessName},e._id))})}),t.jsx(S.Item,{label:"Select Services",name:"serviceIds",rules:[{type:"array",message:"Please select at least one service"}],children:t.jsx(E,{mode:"multiple",placeholder:"Select services",children:N.map(e=>t.jsx($,{value:e._id,children:e.serviceName||e.name},e._id))})}),t.jsx(S.Item,{label:"Date",name:"date",children:t.jsx(z,{style:{width:"100%"}})}),t.jsx(S.Item,{children:t.jsx(x,{type:"primary",htmlType:"submit",children:"Save EOD"})})]})}),t.jsx(P,{title:`EOD Details - ${c==null?void 0:c.name}`,open:J,onCancel:()=>D(!1),footer:t.jsx(x,{onClick:()=>D(!1),children:"Close"}),width:700,children:c&&t.jsxs("div",{children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Date:"})," ",c.date?m(c.date).format("DD-MM-YYYY"):c.dateLabel||"-"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Login:"})," ",c.loginTimeFormatted||"-"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Logout:"})," ",c.logoutTimeFormatted||"-"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Worked Hours:"})," ",V(c.totalHours)]}),t.jsx("p",{children:t.jsx("strong",{children:"EOD Message:"})}),t.jsx("pre",{style:{whiteSpace:"pre-wrap",background:"#f5f5f5",padding:10,borderRadius:4},children:c.eod||"No EOD provided"}),t.jsx("p",{children:t.jsx("strong",{children:"Accounts:"})}),t.jsx("ul",{children:((L=c.accountIds)==null?void 0:L.map(e=>t.jsx("li",{children:e.businessName},e._id)))||t.jsx("li",{children:"-"})}),t.jsx("p",{children:t.jsx("strong",{children:"Services:"})}),t.jsx("ul",{children:((W=c.serviceIds)==null?void 0:W.map(e=>t.jsx("li",{children:e.serviceName||e.name},e._id)))||t.jsx("li",{children:"-"})})]})})]})}export{He as default};
