import{q as t,s as y,B as c,D as q,G as Ue}from"./index-Db3Ct3vh.js";import{r as n,U as d,C as Oe,c as se,h as ae,S as oe,Z as re,B as j,q as _e,v as le,K as Ve,b as Me,E as Ge,M as ne,T as qe,e as ce,y as We,P as Ke,a as Qe}from"./antd-CjRtIVzR.js";import{h as Ye,E as He}from"./html2canvas.esm-DBTO1nPv.js";import{B as Je,N as Ze,F as Xe}from"./FollowUpDrawer-Do9LnWUu.js";import{V as W,a as et,c as tt,T as st,u as at,W as ot}from"./icons-De3RWgvB.js";import"./react-DoC2WAmd.js";import"./moment-C5S46NFB.js";const{Title:rt}=qe,{TabPane:w}=le,k="/api/accounts",ht=()=>{const[ie,I]=n.useState(!1),[P,K]=n.useState(null),[u,ue]=n.useState(""),[p,de]=n.useState("all"),[pe,B]=n.useState(!1),[Q,D]=n.useState(null),[L,R]=n.useState(null),[F,ge]=n.useState([]),[he,Y]=n.useState(!1),[me,H]=n.useState(!1),[U,J]=n.useState(null),[S,O]=n.useState([]),[fe,_]=n.useState(!1),[V,M]=n.useState(null),[m,xe]=n.useState({}),[r,$]=n.useState({current:1,pageSize:10,total:0}),[C,ye]=n.useState({all:0,active:0,customers:0,Pipeline:0,closed:0,quotations:0,TargetLeads:0}),[Se,Ce]=n.useState([]),[be,Z]=n.useState(!1),[ve,X]=n.useState(!0),A=JSON.parse(localStorage.getItem("user")),i=A==null?void 0:A.role,g=A==null?void 0:A._id,ee=n.useRef(null),je=async()=>{Z(!0);try{const e=await y.get("/api/accounts/users");Ce(e.data)}catch(e){console.error("Error fetching users:",e),c.error("Failed to load users for assignment.")}finally{Z(!1)}},b=async()=>{try{let e=`${k}/counts`;i==="Employee"&&g?e+=`?userId=${g}&role=${i}`:i==="Team Leader"&&g&&(e+=`?teamLeaderId=${g}&role=${i}`);const s=await y.get(e);ye(s.data)}catch(e){c.error("Failed to fetch tab counts."),console.error("Fetch counts error:",e)}},f=async(e={})=>{X(!0);try{const{current:s=r.current,pageSize:a=r.pageSize,searchText:o="",activeTab:l="all",sortBy:T="createdAt",sortOrder:h="desc",filters:x=m}=e,N=l==="all"?"":l;let v=`${k}/paginated?page=${s}&pageSize=${a}&search=${o}`;N&&(v+=`&status=${N}`),T&&(v+=`&sortBy=${T}`),h&&(v+=`&sortOrder=${h}`),Object.keys(x).forEach(E=>{x[E]&&x[E].length>0&&(v+=`&${E}=${x[E].join(",")}`)}),i==="Employee"&&g?v+=`&userId=${g}&role=${i}`:i==="Team Leader"&&g&&(v+=`&teamLeaderId=${g}&role=${i}`);const z=await y.get(v);ge(z.data.data),$({...r,current:z.data.page,pageSize:z.data.pageSize,total:z.data.total})}catch(s){c.error("Failed to fetch accounts."),console.error("Fetch accounts error:",s)}finally{X(!1),O([])}};n.useEffect(()=>{if(r.current!==1){$(e=>({...e,current:1}));return}f({current:1,pageSize:r.pageSize,searchText:u,activeTab:p,filters:m}),je()},[u,p,i,g]),n.useEffect(()=>{f({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:m})},[r.current,r.pageSize]),n.useEffect(()=>{b()},[i,g]);const we=async e=>{var s;try{const a={...e};P?(await y.put(`${k}/${P._id}`,a),c.success("Account updated successfully!")):(await y.post(k,a),c.success("Account created successfully!")),I(!1),f({current:1,pageSize:r.pageSize,searchText:u,activeTab:p,filters:m}),b()}catch(a){throw a.response&&a.response.status===409||(c.error("Failed to save account."),console.error("Save account error:",((s=a.response)==null?void 0:s.data)||a.message)),a}},ke=e=>{K(e),I(!0)},Ae=async e=>{var s;try{await y.delete(`${k}/${e}`),c.success("Account status set to Closed!"),f({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:m}),b()}catch(a){c.error("Failed to set account status to Closed."),console.error("Delete account error:",((s=a.response)==null?void 0:s.data)||a.message)}},Te=e=>{J(e),Y(!0)},Ne=e=>{J(e),H(!0)},te=(e,s)=>{D(s),R(e),B(!0)},$e=async()=>{var e;try{const s={...Q,status:L,isCustomer:L==="Customer"};await y.put(`${k}/${Q._id}`,s),c.success(`Account status changed to ${L}!`),f({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:m}),b()}catch(s){c.error("Failed to update account status."),console.error("Status update error:",((e=s.response)==null?void 0:e.data)||s.message)}finally{B(!1),D(null),R(null)}},Ie=()=>{B(!1),D(null),R(null)},G=e=>{if(S.length===0){c.error("Please select at least one account for bulk action.");return}M(e),_(!0)},Le=async()=>{var e;try{const s={ids:S,status:V};await y.put(`${k}/bulk-status-update`,s),c.success(`Successfully updated ${S.length} accounts to ${V}!`),_(!1),M(null),O([]),f({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:m}),b()}catch(s){c.error("Failed to perform bulk status update."),console.error("Bulk status update error:",((e=s.response)==null?void 0:e.data)||s.message)}},Fe=()=>{_(!1),M(null)},ze=async()=>{const e=ee.current;if(!e){c.error("Table content not found for PDF export.");return}c.loading("Generating PDF...",{id:"pdf-toast"});try{const s=await Ye(e,{scale:2}),a=s.toDataURL("image/png"),o=new He("p","mm","a4"),l=210,T=297,h=s.height*l/s.width;let x=h,N=0;for(o.addImage(a,"PNG",0,N,l,h),x-=T;x>=0;)N=x-h,o.addPage(),o.addImage(a,"PNG",0,N,l,h),x-=T;o.save("Leads_Customers_Details.pdf"),c.success("PDF generated!",{id:"pdf-toast"})}catch(s){console.error("Error generating PDF:",s),c.error("Failed to generate PDF.",{id:"pdf-toast"})}},Ee=()=>{if(F.length===0){c.error("No data to export to Excel.");return}const e=F.map((o,l)=>{var h;return{"S.No":l+1+(r.current-1)*r.pageSize,"Business Name":o.businessName,"Contact Name":o.contactName,Email:o.contactEmail,"Mobile Number":o.contactNumber,"Lead Type":o.typeOfLead&&o.typeOfLead.length>0?o.typeOfLead.join(", "):"N/A",Status:o.status,"Source Type":o.sourceType,"Assigned To":((h=o.assignedTo)==null?void 0:h.name)||"Unassigned","GST Number":o.gstNumber,"Phone Number (Alt)":o.contactNumber,"Address Line 1":o.addressLine1,"Address Line 2":o.addressLine2,City:o.city,Pincode:o.pincode,State:o.state,Country:o.country,Website:o.website,"Is Customer":o.isCustomer?"Yes":"No","Created At":new Date(o.createdAt).toLocaleString()}}),s=q.json_to_sheet(e),a=q.book_new();q.book_append_sheet(a,s,"Leads & Customers"),Ue(a,"Leads_Customers_Data.xlsx"),c.success("Data exported to Excel!")},Pe=[{title:"S.No",key:"sno",render:(e,s,a)=>a+1+(r.current-1)*r.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",key:"businessName",sorter:!0,filterDropdown:({setSelectedKeys:e,selectedKeys:s,confirm:a,clearFilters:o})=>t.jsxs("div",{style:{padding:8},children:[t.jsx(se,{placeholder:"Search Business Name",value:s[0],onChange:l=>e(l.target.value?[l.target.value]:[]),onPressEnter:()=>a(),style:{marginBottom:8,display:"block"}}),t.jsx(j,{type:"primary",onClick:()=>a(),icon:t.jsx(ae,{}),size:"small",style:{width:90,marginRight:8,backgroundColor:"#0E2B43",borderColor:"orange",color:"white"},children:"Search"}),t.jsx(j,{onClick:()=>o(),size:"small",style:{width:90},children:"Reset"})]}),responsive:["xs","sm","md","lg"]},{title:"Contact Name",dataIndex:"contactName",key:"contactName",sorter:!0,responsive:["md","lg"]},{title:"Email",dataIndex:"contactEmail",key:"contactEmail",responsive:["lg"]},{title:"Service",dataIndex:"selectedService",key:"selectedService",render:e=>e?e.serviceName:"N/A",responsive:["md","lg"]},{title:"Contact Number",dataIndex:"contactNumber",key:"contactNumber",responsive:["md","lg"]},{title:"Type of Leads",dataIndex:"typeOfLead",key:"typeOfLead",render:e=>t.jsx(oe,{children:e&&e.map(s=>t.jsx(ce,{color:"blue",children:s},s))}),filters:[{text:"Regular",value:"Regular"},{text:"Revenue",value:"Revenue"},{text:"Government",value:"Government"},{text:"Occupational",value:"Occupational"}],filterMultiple:!0,onFilter:(e,s)=>{var a;return(a=s.typeOfLead)==null?void 0:a.includes(e)},responsive:["lg"]},{title:"Status",dataIndex:"status",key:"status",render:e=>{let s;switch(e){case"Active":s="green";break;case"Pipeline":s="orange";break;case"Closed":s="purple";break;case"Customer":s="blue";break;case"Quotations":s="cyan";break;case"TargetLeads":s="gold";break;default:s="gray"}return t.jsx(ce,{color:s,children:e})},filters:[{text:"Active",value:"Active"},{text:"Pipeline",value:"Pipeline"},{text:"Closed",value:"Closed"},{text:"Customer",value:"Customer"},{text:"Quotations",value:"Quotations"},{text:"Target Leads",value:"TargetLeads"}],filterMultiple:!0,responsive:["sm","md","lg"]},{title:"Assigned To",dataIndex:"assignedTo",key:"assignedTo",render:e=>e?e.name:"Unassigned",responsive:["md","lg"]},{title:"Source Type",dataIndex:"sourceType",key:"sourceType",filters:[{text:"Direct",value:"Direct"},{text:"Social Media",value:"socialmedia"},{text:"Website",value:"online"},{text:"Existing Client",value:"client"},{text:"Tradefair",value:"tradefair"},{text:"Other",value:"Other"}],onFilter:(e,s)=>s.sourceType===e,responsive:["lg"]},{title:"Action",key:"action",width:80,render:(e,s)=>t.jsx(re,{overlay:t.jsxs(d,{children:[t.jsx(d.Item,{icon:t.jsx(We,{}),onClick:()=>ke(s),children:"Edit Account"},"edit"),t.jsx(d.Item,{icon:t.jsx(at,{}),onClick:()=>Te(s),children:"View/Add Notes"},"notes"),t.jsx(d.Item,{icon:t.jsx(ot,{}),onClick:()=>Ne(s),children:"View/Add Follow-ups"},"followup"),s.status==="Customer"?t.jsx(d.Item,{onClick:()=>te("Active",s),children:"Change to Lead"},"change-to-lead"):t.jsx(d.Item,{onClick:()=>te("Customer",s),children:"Change to Client"},"change-to-customer"),(i==="Superadmin"||i==="Admin")&&t.jsx(d.Item,{children:t.jsxs(Ke,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>Ae(s._id),okText:"Yes",cancelText:"No",children:[t.jsx(Qe,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:t.jsx(j,{icon:t.jsx(st,{})})})}],Be=(e,s,a)=>{$(e);const o=a.field||"createdAt",l=a.order==="ascend"?"asc":a.order==="descend"?"desc":void 0;xe(s),f({current:e.current,pageSize:e.pageSize,searchText:u,activeTab:p,sortBy:o,sortOrder:l,filters:{status:s.status,sourceType:s.sourceType,typeOfLead:s.typeOfLead}})},De={selectedRowKeys:S,onChange:e=>{O(e)},getCheckboxProps:e=>({disabled:e.status==="Customer"||e.status==="Closed"})},Re=t.jsxs(d,{children:[t.jsx(d.Item,{icon:t.jsx(W,{}),onClick:()=>G("Customer"),children:"Bulk Convert to **Client**"},"customer"),t.jsx(d.Item,{icon:t.jsx(W,{}),onClick:()=>G("Active"),children:"Bulk Convert to **Active Lead**"},"active"),t.jsx(d.Item,{icon:t.jsx(W,{}),onClick:()=>G("Pipeline"),children:"Bulk Convert to **Enquiry**"},"pipeline")]});return t.jsxs(Oe,{title:t.jsx(rt,{level:4,children:"Manage Leads & Clinets"}),children:[t.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"10px"},children:[t.jsx(se,{placeholder:"Search by business or contact name",prefix:t.jsx(ae,{}),style:{width:"100%",maxWidth:300},value:u,onChange:e=>{ue(e.target.value),$({...r,current:1})}}),t.jsxs(oe,{children:[S.length>0&&t.jsx(re,{overlay:Re,trigger:["click"],children:t.jsxs(j,{type:"default",className:"add-event-button",children:["Bulk Actions (",S.length," selected)"]})}),t.jsx(j,{type:"primary",icon:t.jsx(_e,{}),style:{backgroundColor:"#0E2B43",borderColor:"orange",color:"white"},onClick:()=>{K(null),I(!0)},children:"Add New Account"}),t.jsx(j,{icon:t.jsx(et,{}),onClick:ze}),t.jsx(j,{icon:t.jsx(tt,{}),onClick:Ee})]})]}),t.jsxs(le,{defaultActiveKey:"all",onChange:e=>{de(e),$({...r,current:1})},children:[t.jsx(w,{tab:`All Leads (${C.all||0})`},"all"),t.jsx(w,{tab:`Target Leads (${C.TargetLeads||0})`},"TargetLeads"),t.jsx(w,{tab:`Lead (${C.active||0})`},"Active"),t.jsx(w,{tab:`Enquiry (${C.Pipeline||0})`},"Pipeline"),t.jsx(w,{tab:`Quotations Sent (${C.quotations||0})`},"Quotations"),t.jsx(w,{tab:`Converted (${C.customers||0})`},"Customer"),t.jsx(w,{tab:`Closed Accounts (${C.closed||0})`},"Closed")]}),t.jsx("div",{ref:ee,children:ve?t.jsx(Ve,{size:"large",style:{display:"block",margin:"50px auto"}}):F.length>0?t.jsx(Me,{columns:Pe,dataSource:F,rowKey:"_id",scroll:{x:"max-content"},pagination:r,onChange:Be,rowSelection:De}):t.jsx(Ge,{description:"No accounts found."})}),t.jsx(Je,{visible:ie,onClose:()=>I(!1),onSave:we,initialValues:P,allUsers:Se,loadingUsers:be}),U&&t.jsxs(t.Fragment,{children:[t.jsx(Ze,{visible:he,onClose:()=>Y(!1),account:U,refreshAccounts:()=>{f({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:m}),b()}}),t.jsx(Xe,{visible:me,onClose:()=>H(!1),account:U,refreshAccounts:()=>{f({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:m}),b()}})]}),t.jsx(ne,{title:"Change Account Status",open:pe,onOk:$e,onCancel:Ie,okText:"Yes",cancelText:"No",children:t.jsxs("p",{children:["Are you sure you want to change this account's status to"," ","**",L,"**?"]})}),t.jsx(ne,{title:"Confirm Bulk Status Update",open:fe,onOk:Le,onCancel:Fe,okText:"Yes, Update",cancelText:"No",okButtonProps:{style:{backgroundColor:"#1890ff",borderColor:"#1890ff"}},children:t.jsxs("p",{children:["You are about to update the status of **",S.length,"** accounts to **",V,"**. Are you sure you want to proceed?"]})})]})};export{ht as default};
