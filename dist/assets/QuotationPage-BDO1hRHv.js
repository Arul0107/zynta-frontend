import{r as a,x as t,S as q,B as A,V as r}from"./index-Dx0fORvq.js";import{i as v}from"./axios-By3bUnR1.js";import $ from"./QuotationForm-CPOVX9Hl.js";import k from"./QuotationList-CK0HYRXY.js";import{F}from"./index-BHKMv-_S.js";import{D as V}from"./index-C3OeHxcS.js";import{I as U}from"./index-CycGH6gG.js";import{R as B}from"./SendOutlined-DEl5XmWx.js";import{T as O}from"./index-DkVdE_3I.js";import"./index-gtlyNNxV.js";import"./TextArea-Bqwst6Wg.js";import"./index-Bcd2XmZI.js";import"./index-CJ2clCQa.js";import"./index-C1eVaR1v.js";import"./index-CGWGFuT9.js";import"./PlusOutlined-Dt2q3nHd.js";import"./index-toTrP2vq.js";import"./row-D7mQAf0A.js";import"./index-DmCauXk3.js";import"./DeleteOutlined-DlHM_4f9.js";import"./MinusCircleOutlined-CncFMDVt.js";import"./SaveOutlined-BPE7Lej8.js";import"./moment-C5S46NFB.js";import"./index-D5gtJ-xG.js";import"./extendsObject-78o_rR5W.js";import"./Pagination-9G_nljkd.js";import"./html2canvas.esm-BSE4e0vj.js";import"./Table-BFHR8fXI.js";import"./styleChecker-BIxzM-w-.js";import"./addEventListener-CZDGFXVg.js";import"./index-Bq5jwgzS.js";import"./index-Cdvz5H4l.js";import"./ExclamationCircleFilled-ctPYYyzk.js";import"./InfoCircleFilled-CGhkVSDg.js";import"./ActionButton-DcYFGn3W.js";import"./index-o4REvhBZ.js";import"./useClosable-D6ihuouj.js";import"./context-LTZAWJIx.js";import"./index-B8wKftBc.js";import"./index-BGnsSyBi.js";import"./PrinterOutlined-Bf2hBR8h.js";import"./MessageOutlined-B6KeS4ko.js";import"./ScheduleOutlined-B90A6p-T.js";import"./EditOutlined--TcujLaX.js";import"./index-D4CZw55Y.js";const{TextArea:P}=U,{Title:R,Text:_}=O,H=({visible:x,onClose:Q,quotation:n,refreshQuotations:d})=>{const[u]=F.useForm(),[i,w]=a.useState(!1),[m,S]=a.useState([]);a.useEffect(()=>{S((n==null?void 0:n.notes)||[])},[n]);const N=()=>{try{const o=JSON.parse(localStorage.getItem("user"));return(o==null?void 0:o.email)||"Unknown"}catch{return"Unknown"}},j=async o=>{try{w(!0);const l=r.loading("Adding note..."),c={text:o.note,timestamp:new Date().toLocaleString(),author:N()},p=[...m,c];await v.put(`/api/quotations/${n._id}`,{notes:p}),S(p),r.success("Note added",{id:l}),u.resetFields(),d()}catch{r.error("Failed to add note")}finally{w(!1)}},D=()=>m.length?m.map((o,l)=>{const c=l>0?m[l-1]:null,p=new Date(o.timestamp).toDateString(),b=c?new Date(c.timestamp).toDateString():null,C=p!==b;return t.jsxs("div",{children:[C&&t.jsx("div",{className:"note-date-header",children:p}),t.jsxs("div",{className:"note-bubble",children:[t.jsxs("div",{className:"note-meta",children:[o.author,"    ",o.timestamp]}),t.jsx("div",{className:"note-text",children:o.text})]})]},l)}):t.jsx(_,{type:"secondary",children:"No notes added yet"});return t.jsx(V,{title:t.jsxs(R,{level:4,style:{margin:0},children:["Notes for Quotation #",n==null?void 0:n.quotationNumber]}),open:x,onClose:Q,width:440,destroyOnClose:!0,children:t.jsxs(q,{spinning:i,children:[t.jsx("div",{style:{maxHeight:460,overflowY:"auto",marginBottom:16},children:D()}),t.jsxs(F,{form:u,layout:"vertical",onFinish:j,children:[t.jsx(F.Item,{name:"note",rules:[{required:!0,message:"Please enter a note"}],children:t.jsx(P,{rows:3,placeholder:"Type your note here"})}),t.jsx(A,{type:"primary",htmlType:"submit",loading:i,block:!0,icon:t.jsx(B,{}),children:"Add Note"})]})]})})},$t=()=>{const[x,Q]=a.useState([]),[n,d]=a.useState(!1),[u,i]=a.useState(null),[w,m]=a.useState([]),[S,N]=a.useState(!1),[j,D]=a.useState(!1),[o,l]=a.useState(!1),c=async()=>{D(!0);const s=r.loading("Loading quotations...");try{const e=await v.get("/api/quotations");Q(e.data),m(e.data),r.success("Quotations loaded successfully",{id:s})}catch(e){r.error("Failed to load quotations",{id:s}),console.error("Error fetching quotations:",e)}finally{D(!1)}};a.useEffect(()=>{c()},[]);const p=async s=>{var h,f,y;if(o){r("Quotation save in progress. Please wait...",{icon:"⏳"});return}l(!0);const e=r.loading("Saving quotation...");try{u?await v.put(`/api/quotations/${u._id}`,s):await v.post("/api/quotations",s),r.success("Quotation saved successfully!",{id:e}),await c(),d(!1),i(null)}catch(g){console.error("Error saving quotation:",((h=g.response)==null?void 0:h.data)||g),r.error(`Failed to save quotation: ${((y=(f=g.response)==null?void 0:f.data)==null?void 0:y.error)||g.message||"Unknown error"}`,{id:e})}finally{l(!1)}},b=async s=>{const e=r.loading("Deleting quotation...");try{await v.delete(`/api/quotations/${s}`),r.success("Quotation deleted successfully",{id:e}),c()}catch(h){r.error(`Failed to delete quotation: ${h.message}`,{id:e}),console.error("Error deleting quotation:",h)}},C=s=>{const e=s.toLowerCase(),h=x.filter(f=>{var y,g,I,L;return((y=f.businessName)==null?void 0:y.toLowerCase().includes(e))||((g=f.customerName)==null?void 0:g.toLowerCase().includes(e))||((I=f.quotationNumber)==null?void 0:I.toLowerCase().includes(e))||((L=f.notes)==null?void 0:L.some(T=>{var E;return(E=T.text)==null?void 0:E.toLowerCase().includes(e)}))});m(h)};return t.jsxs(t.Fragment,{children:[t.jsx(k,{quotations:w.length>0||w.length===0&&x.length===0&&!j?w:x,onAddNew:()=>{i(null),d(!0)},onEdit:s=>{i(s),d(!0)},onDelete:b,onSearch:C,onViewNotes:s=>{i(s),N(!0)},loading:j}),t.jsx(V,{open:n,title:u?"Edit Quotation":"Create Quotation",onClose:()=>{d(!1),i(null)},width:window.innerWidth>768?"80vw":"95vw",destroyOnClose:!0,children:t.jsx($,{initialValues:u,onSave:p,onCancel:()=>{d(!1),i(null)},isSaving:o})}),t.jsx(H,{visible:S,onClose:()=>{N(!1),i(null)},quotation:u,refreshQuotations:c})]})};export{$t as default};
