import{r as n,x as t,O as re,y as R,B as h,V as u}from"./index-CzhUO-j-.js";import{i as S}from"./axios-By3bUnR1.js";import{D as Y,d}from"./index-mKLDrSdO.js";import{F as f}from"./index-BvPXtaWX.js";import{R as ae}from"./row-OZxQAKlt.js";import{T as ie}from"./index-C4h5jtsp.js";import{F as ne}from"./Table-DFMW3Ydh.js";import{M as H}from"./index-13yZt8pQ.js";import{I as le}from"./index-DhqNJc9P.js";import{S as D}from"./index-C8yeWvpE.js";import{P as ce}from"./index-DPLXVn8e.js";import"./TextArea-DXZam5Hb.js";import"./ExclamationCircleFilled-DJFsQvbq.js";import"./EditOutlined-BMpNAhkC.js";import"./styleChecker-B_q3kf9f.js";import"./addEventListener-CEFnZ_sV.js";import"./index-B7S4UWYb.js";import"./Pagination-D_gJDmdp.js";import"./extendsObject-78o_rR5W.js";import"./InfoCircleFilled-BHF3Pce5.js";import"./ActionButton-LNqSuIr7.js";import"./index-DjwdYPep.js";import"./useClosable-dDnesZuT.js";import"./context-C3C_yqM-.js";const{Title:de}=ie,{TextArea:me}=le,{Option:W}=D,{RangePicker:ue}=Y;function Re(){var N,V;const[w,y]=n.useState([]),[F,g]=n.useState(!1),[L,b]=n.useState(!1),[O,$]=n.useState(null),[_]=f.useForm(),[P,I]=n.useState({}),[j,E]=n.useState({}),[B,U]=n.useState([]),[G,J]=n.useState([]),[K,M]=n.useState(!1),[i,q]=n.useState(null),[k,z]=n.useState([]),p=JSON.parse(localStorage.getItem("user"))||{_id:"temp_id_123",name:"Guest User",role:"Employee",email:"guest@example.com"},T=["Admin","Superadmin"].includes(p.role),Q=async()=>{try{const[e,s]=await Promise.all([S.get("/api/accounts"),S.get("/api/service")]);U(e.data||[]),J(s.data||[])}catch{u.error("Failed to fetch accounts or services")}},X=e=>{const s=Math.floor(Math.abs(e)/3600),o=Math.floor(Math.abs(e)%3600/60),r=Math.floor(Math.abs(e)%60);return`${e<0?"+":""}${s.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},v=e=>{if(!e)return"";const s=Math.floor(e*3600),o=Math.floor(s/3600),r=Math.floor(s%3600/60),a=s%60;return`${o}h ${r}m ${a}s`},A=async()=>{try{g(!0);let e,s;k&&k.length===2?(e=k[0].startOf("day").toISOString(),s=k[1].endOf("day").toISOString()):(e=d().startOf("day").toISOString(),s=d().endOf("day").toISOString());const o={start:e,end:s};T||(o.userId=p._id);const a=(await S.get("/api/work-sessions/range",{params:o})).data.history||[],c=[];a.forEach(l=>{l.sessions.forEach(m=>{(T||m.userId===p._id)&&c.push({...m,key:m._id,dateLabel:l.date,loginTimeFormatted:d(m.loginTime).format("hh:mm:ss A"),logoutTimeFormatted:m.logoutTime?d(m.logoutTime).format("hh:mm:ss A"):""})})}),y(c);const x={},C={};c.forEach(l=>{const m=l.totalHours?Math.floor(l.totalHours*3600):0;x[l.key]=l.logoutTime?m:Math.floor(8*3600-(Date.now()-new Date(l.loginTime).getTime())/1e3),C[l.key]=!l.logoutTime}),I(x),E(C)}catch(e){console.error(e),u.error("Failed to fetch sessions")}finally{g(!1)}};n.useEffect(()=>{Q(),A()},[]),n.useEffect(()=>{const e=setInterval(()=>{I(s=>{const o={};return Object.keys(s).forEach(r=>{o[r]=j[r]?s[r]-1:s[r]}),o})},1e3);return()=>clearInterval(e)},[j]);const Z=async()=>{var e,s;g(!0);try{const r=(await S.post("/api/work-sessions/start",{userId:p._id,name:p.name,email:p.email})).data.session;y(a=>[...a,{key:r._id,...r,loginTimeFormatted:d(r.loginTime).format("hh:mm:ss A"),logoutTimeFormatted:"",dateLabel:d(r.loginTime).format("YYYY-MM-DD")}]),I(a=>({...a,[r._id]:8*3600})),E(a=>({...a,[r._id]:!0})),u.success("Work started successfully!")}catch(o){u.error(((s=(e=o.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to start work")}finally{g(!1)}},ee=async e=>{var s,o;g(!0);try{const a=(await S.post("/api/work-sessions/stop",{sessionId:e})).data.session;y(c=>c.map(x=>x.key===e?{...x,logoutTimeFormatted:d(a.logoutTime).format("hh:mm:ss A"),totalHours:a.totalHours}:x)),E(c=>({...c,[e]:!1})),I(c=>({...c,[e]:Math.floor(a.totalHours*3600)})),u.success("Work stopped successfully!")}catch(r){u.error(((o=(s=r.response)==null?void 0:s.data)==null?void 0:o.message)||"Failed to stop work")}finally{g(!1)}},te=async e=>{try{await S.post("/api/work-sessions/eod",{sessionId:O.key,eod:e.eod,accountIds:e.accountIds,serviceIds:e.serviceIds,date:e.date?e.date.toISOString():null}),y(s=>s.map(o=>o.key===O.key?{...o,eod:e.eod,accountIds:e.accountIds,serviceIds:e.serviceIds,date:e.date?e.date.toISOString():o.date}:o)),b(!1),_.resetFields(),u.success("EOD saved!")}catch{u.error("Failed to save EOD")}},se=e=>{q(e),M(!0)},oe=[{title:"Date",dataIndex:"dateLabel"},{title:"Name",dataIndex:"name"},{title:"Login",dataIndex:"loginTimeFormatted"},{title:"Logout",dataIndex:"logoutTimeFormatted"},{title:"Timer",render:(e,s)=>t.jsx("span",{className:j[s.key]?"countdown":"overtime",children:X(P[s.key]||0)})},{title:"Worked Hours",dataIndex:"totalHours",render:(e,s)=>v(s.totalHours)},{title:"Accounts",render:(e,s)=>{var o;return((o=s.accountIds)==null?void 0:o.map(r=>r.businessName).join(", "))||"-"}},{title:"Services",render:(e,s)=>{var o;return((o=s.serviceIds)==null?void 0:o.map(r=>r.serviceName||r.name).join(", "))||"-"}},{title:"EOD",render:(e,s)=>t.jsxs(R,{children:[t.jsx(h,{type:"link",onClick:()=>{var o,r;$(s),b(!0),_.setFieldsValue({eod:s.eod||"",accountIds:((o=s.accountIds)==null?void 0:o.map(a=>a._id))||[],serviceIds:((r=s.serviceIds)==null?void 0:r.map(a=>a._id))||[],date:s.date?d(s.date):null})},children:s.eod?"Edit":"Add"}),s.eod&&t.jsx(h,{type:"link",onClick:()=>se(s),children:"View"})]})},{title:"Actions",render:(e,s)=>{const o=j[s.key],r=s.userId===p._id;return o&&(T||r)?t.jsx(ce,{title:"Are you sure you want to stop work?",onConfirm:()=>ee(s.key),okText:"Yes",cancelText:"No",children:t.jsx(h,{type:"danger",children:"Stop Work"})}):null}}];return t.jsxs("div",{style:{padding:24},children:[t.jsx(re,{position:"top-right",reverseOrder:!1}),t.jsxs(ae,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[t.jsx(de,{level:2,children:"Timesheet Dashboard"}),t.jsxs(R,{children:[t.jsx(ue,{onChange:z}),t.jsx(h,{type:"primary",onClick:A,loading:F,children:"Fetch History"}),!T&&(!w[0]||!j[w[0].key])&&t.jsx(h,{type:"primary",loading:F,onClick:Z,children:"Start Work"})]})]}),t.jsx(ne,{columns:oe,dataSource:w,pagination:!1,rowKey:"key"}),t.jsx(H,{title:"End of Day Notes",open:L,onCancel:()=>b(!1),footer:null,children:t.jsxs(f,{form:_,layout:"vertical",onFinish:te,children:[t.jsx(f.Item,{label:"EOD Message",name:"eod",children:t.jsx(me,{rows:4})}),t.jsx(f.Item,{label:"Select Accounts",name:"accountIds",children:t.jsx(D,{mode:"multiple",placeholder:"Select accounts",children:B.map(e=>t.jsx(W,{value:e._id,children:e.businessName},e._id))})}),t.jsx(f.Item,{label:"Select Services",name:"serviceIds",children:t.jsx(D,{mode:"multiple",placeholder:"Select services",children:G.map(e=>t.jsx(W,{value:e._id,children:e.serviceName||e.name},e._id))})}),t.jsx(f.Item,{label:"Date",name:"date",children:t.jsx(Y,{style:{width:"100%"}})}),t.jsx(f.Item,{children:t.jsx(h,{type:"primary",htmlType:"submit",children:"Save"})})]})}),t.jsx(H,{title:`EOD Details - ${i==null?void 0:i.name}`,open:K,onCancel:()=>M(!1),footer:t.jsx(h,{onClick:()=>M(!1),children:"Close"}),width:700,children:i&&t.jsxs("div",{children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Name:"})," ",i.name]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Date:"})," ",i.date?d(i.date).format("YYYY-MM-DD"):"-"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Login:"})," ",i.loginTimeFormatted||"-"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Logout:"})," ",i.logoutTimeFormatted||"-"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Worked Hours:"})," ",v(i.totalHours)]}),t.jsx("p",{children:t.jsx("strong",{children:"EOD Message:"})}),t.jsx("pre",{style:{whiteSpace:"pre-wrap",background:"#f5f5f5",padding:10},children:i.eod||"No EOD provided"}),t.jsx("p",{children:t.jsx("strong",{children:"Accounts:"})}),t.jsx("ul",{children:((N=i.accountIds)==null?void 0:N.map(e=>t.jsx("li",{children:e.businessName},e._id)))||t.jsx("li",{children:"-"})}),t.jsx("p",{children:t.jsx("strong",{children:"Services:"})}),t.jsx("ul",{children:((V=i.serviceIds)==null?void 0:V.map(e=>t.jsx("li",{children:e.serviceName||e.name},e._id)))||t.jsx("li",{children:"-"})})]})})]})}export{Re as default};
